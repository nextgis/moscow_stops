(function(c){var a=new Array();var b=new Array();c.fn.doAutosize=function(h){var f=c(this).data("minwidth"),p=c(this).data("maxwidth"),k="",n=c(this),j=c("#"+c(this).data("tester_id"));if(k===(k=n.val())){return}var e=k.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");j.html(e);var m=j.width(),l=(m+h.comfortZone)>=f?m+h.comfortZone:f,g=n.width(),d=(l<g&&l>=f)||(l>f&&l<p);if(d){n.width(l)}};c.fn.resetAutosize=function(f){var h=c(this).data("minwidth")||f.minInputWidth||c(this).width(),j=c(this).data("maxwidth")||f.maxInputWidth||(c(this).closest(".tagsinput").width()-f.inputPadding),k="",e=c(this),g=c("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),d=c(this).attr("id")+"_autosize_tester";if(!c("#"+d).length>0){g.attr("id",d);g.appendTo("body")}e.data("minwidth",h);e.data("maxwidth",j);e.data("tester_id",d);e.css("width",h)};c.fn.addTag=function(e,d){d=jQuery.extend({focus:false,callback:true},d);this.each(function(){var l=c(this).attr("id");var g=c(this).val().split(a[l]);if(g[0]==""){g=new Array()}e=jQuery.trim(e);if(d.unique){var h=c(this).tagExist(e);if(h==true){c("#"+l+"_tag").addClass("not_valid")}}else{var h=false}if(e!=""&&h!=true){c("<span>").addClass("tag").append(c("<span>").text(e).append("&nbsp;&nbsp;"),c("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return c("#"+l).removeTag(escape(e))})).insertBefore("#"+l+"_addTag");g.push(e);c("#"+l+"_tag").val("");if(d.focus){c("#"+l+"_tag").focus()}else{c("#"+l+"_tag").blur()}c.fn.tagsInput.updateTagsField(this,g);if(d.callback&&b[l]&&b[l]["onAddTag"]){var k=b[l]["onAddTag"];k.call(this,e)}if(b[l]&&b[l]["onChange"]){var j=g.length;var k=b[l]["onChange"];k.call(this,c(this),g[j-1])}}});return false};c.fn.removeTag=function(d){d=unescape(d);this.each(function(){var h=c(this).attr("id");var e=c(this).val().split(a[h]);c("#"+h+"_tagsinput .tag").remove();str="";for(i=0;i<e.length;i++){if(e[i]!=d){str=str+a[h]+e[i]}}c.fn.tagsInput.importTags(this,str);if(b[h]&&b[h]["onRemoveTag"]){var g=b[h]["onRemoveTag"];g.call(this,d)}});return false};c.fn.tagExist=function(e){var f=c(this).attr("id");var d=c(this).val().split(a[f]);return(jQuery.inArray(e,d)>=0)};c.fn.importTags=function(d){id=c(this).attr("id");c("#"+id+"_tagsinput .tag").remove();c.fn.tagsInput.importTags(this,d)};c.fn.tagsInput=function(d){var e=jQuery.extend({interactive:true,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:false},hide:true,delimiter:",",unique:true,removeWithBackspace:true,placeholderColor:"#666666",autosize:true,comfortZone:20,inputPadding:6*2},d);this.each(function(){if(e.hide){c(this).hide()}var h=c(this).attr("id");if(!h||a[c(this).attr("id")]){h=c(this).attr("id","tags"+new Date().getTime()).attr("id")}var g=jQuery.extend({pid:h,real_input:"#"+h,holder:"#"+h+"_tagsinput",input_wrapper:"#"+h+"_addTag",fake_input:"#"+h+"_tag"},e);a[h]=g.delimiter;if(e.onAddTag||e.onRemoveTag||e.onChange){b[h]=new Array();b[h]["onAddTag"]=e.onAddTag;b[h]["onRemoveTag"]=e.onRemoveTag;b[h]["onChange"]=e.onChange}var f='<div id="'+h+'_tagsinput" class="tagsinput"><div id="'+h+'_addTag">';if(e.interactive){f=f+'<input id="'+h+'_tag" value="" data-default="'+e.defaultText+'" />'}f=f+'</div><div class="tags_clear"></div></div>';c(f).insertAfter(this);c(g.holder).css("width",e.width);c(g.holder).css("min-height",e.height);c(g.holder).css("height","100%");if(c(g.real_input).val()!=""){c.fn.tagsInput.importTags(c(g.real_input),c(g.real_input).val())}if(e.interactive){c(g.fake_input).val(c(g.fake_input).attr("data-default"));c(g.fake_input).css("color",e.placeholderColor);c(g.fake_input).resetAutosize(e);c(g.holder).bind("click",g,function(j){c(j.data.fake_input).focus()});c(g.fake_input).bind("focus",g,function(j){if(c(j.data.fake_input).val()==c(j.data.fake_input).attr("data-default")){c(j.data.fake_input).val("")}c(j.data.fake_input).css("color","#000000")});if(e.autocomplete_url!=undefined){autocomplete_options={source:e.autocomplete_url};for(attrname in e.autocomplete){autocomplete_options[attrname]=e.autocomplete[attrname]}if(jQuery.Autocompleter!==undefined){c(g.fake_input).autocomplete(e.autocomplete_url,e.autocomplete);c(g.fake_input).bind("result",g,function(j,l,k){if(l){c("#"+h).addTag(l[0]+"",{focus:true,unique:(e.unique)})}})}else{if(jQuery.ui.autocomplete!==undefined){c(g.fake_input).autocomplete(autocomplete_options);c(g.fake_input).bind("autocompleteselect",g,function(j,k){c(j.data.real_input).addTag(k.item.value,{focus:true,unique:(e.unique)});return false})}}}else{c(g.fake_input).bind("blur",g,function(j){var k=c(this).attr("data-default");if(c(j.data.fake_input).val()!=""&&c(j.data.fake_input).val()!=k){if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}}else{c(j.data.fake_input).val(c(j.data.fake_input).attr("data-default"));c(j.data.fake_input).css("color",e.placeholderColor)}return false})}c(g.fake_input).bind("keypress",g,function(j){if(j.which==j.data.delimiter.charCodeAt(0)||j.which==13){j.preventDefault();if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}c(j.data.fake_input).resetAutosize(e);return false}else{if(j.data.autosize){c(j.data.fake_input).doAutosize(e)}}});g.removeWithBackspace&&c(g.fake_input).bind("keydown",function(k){if(k.keyCode==8&&c(this).val()==""){k.preventDefault();var j=c(this).closest(".tagsinput").find(".tag:last").text();var l=c(this).attr("id").replace(/_tag$/,"");j=j.replace(/[\s]+x$/,"");c("#"+l).removeTag(escape(j));c(this).trigger("focus")}});c(g.fake_input).blur();if(g.unique){c(g.fake_input).keydown(function(j){if(j.keyCode==8||String.fromCharCode(j.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){c(this).removeClass("not_valid")}})}}});return this};c.fn.tagsInput.updateTagsField=function(e,d){var f=c(e).attr("id");c(e).val(d.join(a[f]))};c.fn.tagsInput.importTags=function(g,h){c(g).val("");var j=c(g).attr("id");var d=h.split(a[j]);for(i=0;i<d.length;i++){c(g).addTag(d[i],{focus:false,callback:false})}if(b[j]&&b[j]["onChange"]){var e=b[j]["onChange"];e.call(g,g,d[i])}}})(jQuery);
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var w={};w.name="mustache.js";w.version="0.7.2";w.tags=["{{","}}"];w.Scanner=u;w.Context=s;w.Writer=q;var d=/\s*/;var l=/\s+/;var h=/\S/;var g=/\s*=/;var n=/\s*\}/;var t=/#|\^|\/|>|\{|&|=|!/;var j=RegExp.prototype.test;var v=Object.prototype.toString;function o(z,y){return j.call(z,y)}function f(y){return !o(h,y)}var k=Array.isArray||function(y){return v.call(y)==="[object Array]"};function e(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function m(y){return String(y).replace(/[&<>"'\/]/g,function(z){return c[z]})}w.escape=m;function u(y){this.string=y;this.tail=y;this.pos=0}u.prototype.eos=function(){return this.tail===""};u.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};u.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function s(y,z){this.view=y;this.parent=z;this._cache={}}s.make=function(y){return(y instanceof s)?y:new s(y)};s.prototype.push=function(y){return new s(y,this)};s.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function q(){this.clearCache()}q.prototype.clearCache=function(){this._cache={};this._partialCache={}};q.prototype.compile=function(A,y){var z=this._cache[A];if(!z){var B=w.parse(A,y);z=this._cache[A]=this.compileTokens(B,A)}return z};q.prototype.compilePartial=function(z,B,y){var A=this.compile(B,y);this._partialCache[z]=A;return A};q.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};q.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return p(A,y,s.make(B),z)}};q.prototype.render=function(A,y,z){return this.compile(A)(y,z)};function p(F,z,y,I){var C="";var A,G,H;for(var D=0,E=F.length;D<E;++D){A=F[D];G=A[1];switch(A[0]){case"#":H=y.lookup(G);if(typeof H==="object"){if(k(H)){for(var B=0,K=H.length;B<K;++B){C+=p(A[4],z,y.push(H[B]),I)}}else{if(H){C+=p(A[4],z,y.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(y.view,J,function(M){return z.render(M,y)});if(H!=null){C+=H}}else{if(H){C+=p(A[4],z,y,I)}}}break;case"^":H=y.lookup(G);if(!H||(k(H)&&H.length===0)){C+=p(A[4],z,y,I)}break;case">":H=z.getPartial(G);if(typeof H==="function"){C+=H(y)}break;case"&":H=y.lookup(G);if(H!=null){C+=H}break;case"name":H=y.lookup(G);if(H!=null){C+=w.escape(H)}break;case"text":C+=G;break}}return C}function x(E){var z=[];var D=z;var F=[];var B;for(var A=0,y=E.length;A<y;++A){B=E[A];switch(B[0]){case"#":case"^":F.push(B);D.push(B);D=B[4]=[];break;case"/":var C=F.pop();C[5]=B[2];D=F.length>0?F[F.length-1][4]:z;break;default:D.push(B)}}return z}function a(D){var A=[];var C,z;for(var B=0,y=D.length;B<y;++B){C=D[B];if(C){if(C[0]==="text"&&z&&z[0]==="text"){z[1]+=C[1];z[3]=C[3]}else{z=C;A.push(C)}}}return A}function r(y){return[new RegExp(e(y[0])+"\\s*"),new RegExp("\\s*"+e(y[1]))]}w.parse=function(P,E){P=P||"";E=E||w.tags;if(typeof E==="string"){E=E.split(l)}if(E.length!==2){throw new Error("Invalid tags: "+E.join(", "))}var I=r(E);var A=new u(P);var G=[];var F=[];var D=[];var Q=false;var O=false;function N(){if(Q&&!O){while(D.length){delete F[D.pop()]}}else{D=[]}Q=false;O=false}var B,z,H,J,C;while(!A.eos()){B=A.pos;H=A.scanUntil(I[0]);if(H){for(var K=0,M=H.length;K<M;++K){J=H.charAt(K);if(f(J)){D.push(F.length)}else{O=true}F.push(["text",J,B,B+1]);B+=1;if(J=="\n"){N()}}}if(!A.scan(I[0])){break}Q=true;z=A.scan(t)||"name";A.scan(d);if(z==="="){H=A.scanUntil(g);A.scan(g);A.scanUntil(I[1])}else{if(z==="{"){H=A.scanUntil(new RegExp("\\s*"+e("}"+E[1])));A.scan(n);A.scanUntil(I[1]);z="&"}else{H=A.scanUntil(I[1])}}if(!A.scan(I[1])){throw new Error("Unclosed tag at "+A.pos)}C=[z,H,B,A.pos];F.push(C);if(z==="#"||z==="^"){G.push(C)}else{if(z==="/"){if(G.length===0){throw new Error('Unopened section "'+H+'" at '+B)}var y=G.pop();if(y[1]!==H){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(z==="name"||z==="{"||z==="&"){O=true}else{if(z==="="){E=H.split(l);if(E.length!==2){throw new Error("Invalid tags at "+B+": "+E.join(", "))}I=r(E)}}}}}var y=G.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+A.pos)}F=a(F);return x(F)};var b=new q();w.clearCache=function(){return b.clearCache()};w.compile=function(z,y){return b.compile(z,y)};w.compilePartial=function(z,A,y){return b.compilePartial(z,A,y)};w.compileTokens=function(z,y){return b.compileTokens(z,y)};w.render=function(A,y,z){return b.render(A,y,z)};w.to_html=function(B,z,A,C){var y=w.render(B,z,A);if(typeof C==="function"){C(y)}else{return y}};return w}())));(function(a){a.sm={};a.viewmodel={};a.view={};a.templates={};a.extend(a.viewmodel,{version:null});a.extend(a.view,{$document:null});a.sm.loader={};a.extend(a.sm.loader,{templates:["osmPopupTemplate","stopPopupTemplate","stopPopupInfoTemplate"],init:function(){try{this.setDomOptions();this.compileTemplates();a.sm.common.init();a.sm.map.init();a.sm.searcher.init();a.sm.editor.init();a.sm.osm.init();a.sm.user.init();a.sm.stops.init()}catch(b){alert(b)}},bindEvents:function(){},showErrorPopup:function(){},setPopups:function(){},setDomOptions:function(){a.view.$document=a(document)},compileTemplates:function(){var d=this,g=[],c=[],e=[],f,b=this.templates.length;for(f=0;f<b;f++){g.push(a.get(document.url_root+"static/js/templates/"+this.templates[f]+".htm",function(k,j,h){e.push({name:this.url.substr((this.url.lastIndexOf("/")+1)).replace(".htm",""),html:h.responseText})}))}a.when.apply(null,g).done(function(){for(f=0;f<b;f++){var h=e[f].name;a.templates[h]=Mustache.compile(e[f].html)}})}});a(document).ready(function(){a.sm.loader.init()})})(jQuery);(function(a){a.sm.helpers={};a.extend(a.sm.helpers,{getIcon:function(c,b){return L.divIcon({className:c,iconSize:[b,b],iconAnchor:[b/2,b/2],popupAnchor:[0,2-(b/2)]})},hashToArrayKeyValues:function(c){var b=[];if(Object.prototype.toString.call(c)==="[object Array]"){return c}for(var d in c){if(!c.hasOwnProperty(d)){continue}b.push({key:d,val:c[d]})}return b},boolToString:function(b){switch(b){case null:return"";break;case"True":return"Да";break;case"False":return"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(b){if(b===null){return""}return b},valueCheckToString:function(b){switch(b){case 0:return"Не нужна";break;case 1:return"Нужна";break;case 2:return"Проверена";break}}})})(jQuery);(function(a){a.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});a.extend(a.view,{$body:null});a.sm.common={};a.extend(a.sm.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){},showErrorPopup:function(){},setPopups:function(){},setDomOptions:function(){a.view.$body=a("body")}})})(jQuery);(function(a){a.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});a.extend(a.view,{});a.sm.map={};a.extend(a.sm.map,{init:function(){this.setDomOptions();this.buildMap();this.bindEvents()},bindEvents:function(){a.viewmodel.map.on("moveend",function(b){a.when(a.view.$document.trigger("/sm/osm/updateOsmLayer"),a.view.$document.trigger("/sm/stops/updateStops")).then(function(){var c=a.viewmodel.mapLayers.select._layers,d=c[Object.keys(c)[0]];if(d&&!a.viewmodel.isPopupOpened){d.openPopup();a.viewmodel.isPopupOpened=true;a.view.$document.trigger("/sm/map/openPopupEnd")}})});a.view.$document.on("/sm/map/openPopup",function(g,f){var d=a.viewmodel,c=d.mapLayers.select,b=a.extend(true,{},f);c.clearLayers();c.addLayer(b);d.map.panTo(f._latlng)});a.view.$document.on("/sm/map/MarkerClick",function(b){a.viewmodel.mapLayers.select.clearLayers();a.viewmodel.map.closePopup()});a.viewmodel.map.on("popupclose",function(){var b=a.viewmodel;b.isPopupOpened=false;b.mapLayers.select.clearLayers()})},setDomOptions:function(){},getBbox:function(){return this.map.getBounds()},buildMap:function(){var d=this,b="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",e="Map data © OpenStreetMap contributors",f=new L.TileLayer(b,{minZoom:8,maxZoom:18,attribution:e}),c=L.layerGroup();a.viewmodel.map=new L.Map("map");a.viewmodel.map.setView(new L.LatLng(55.742,37.658),15);a.viewmodel.map.addLayer(f);a.viewmodel.mapLayers.osm=f;a.viewmodel.get_bbox=d.getBbox;a.viewmodel.map.addLayer(c);a.viewmodel.mapLayers.select=c}})})(jQuery);(function(a){a.extend(a.sm.map,{getIcon:function(c,b){return L.divIcon({className:c,iconSize:[b,b],iconAnchor:[b/2,b/2],popupAnchor:[0,2-(b/2)]})}})})(jQuery);(function(a){a.extend(a.viewmodel,{searcherCollapsed:false});a.extend(a.view,{$searchContainer:null});a.sm.searcher={};a.extend(a.sm.searcher,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var b=this;a.view.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",b.searcherCollapsed)})},setDomOptions:function(){a.view.$searchContainer=a("#searchContainer")},search:function(b,c){}})})(jQuery);(function(a){a.extend(a.viewmodel,{editorCollapsed:false,editable:false,routeTypeSelected:null});a.extend(a.view,{$editorContainer:null});a.sm.editor={};a.extend(a.sm.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},init:function(){this.setDomOptions();this.buildTags();this.buildEditLayer();this.buildRoutesSelector();this.bindEvents()},bindEvents:function(){var b=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.editorCollapsed=!a.viewmodel.editorCollapsed;a.view.$body.toggleClass("editor-collapsed",b.editorCollapsed)});a("#pan_link").off("input").on("input",function(d){var c=document.getElementById("pan_link_a");if(b.regex.url.test(d.target.value)){c.className="active";c.href=d.target.value}else{c.className="";c.href=""}});a.view.$document.on("/sm/editor/startEdit",function(c){b.startEdit()});a("#save").off("click").on("click",function(c){c.stopPropagation();b.save()});a("#discard").off("click").on("click",function(c){c.stopPropagation();b.discard()});a("#route_type").off("change").on("change",function(c){a("#route_type_"+a.viewmodel.routeTypeSelected).hide();a("#route_type_"+c.target.value).show();a.viewmodel.routeTypeSelected=c.target.value})},setDomOptions:function(){a.view.$editorContainer=a("#editorContainer")},buildTags:function(){a("#routes").tagsInput({defaultText:"+",width:"185px",maxChars:5,interactive:false})},buildEditLayer:function(){var b=L.layerGroup();a.viewmodel.mapLayers.edit=a.viewmodel.map.addLayer(b)},buildRoutesSelector:function(){var b=a("#route_type").find(":selected").val();a("#route_type_"+b).show();a.viewmodel.routeTypeSelected=b},save:function(){var f=this,g=a("#editorContainer form"),j=g.serializeArray(),e=0,h=j.length,c=document.url_root+"stop/"+a.viewmodel.stopSelected.id,d={id:a.viewmodel.stopSelected.id},b;for(e;e<h;e+=1){b=j[e].name;switch(b){case b==="lon":d.geom["lon"]=j[e].value;break;case b==="lat":d.geom["lat"]=j[e].value;break;default:d[j[e].name]=j[e].value;break}}a.ajax({type:"POST",url:c,data:{stop:JSON.stringify(d)}}).done(function(){f.finishEditing()})},discard:function(){this.finishEditing()},startEdit:function(){var e=a.sm.helpers.getIcon("stop-editable",25),d=a.viewmodel,c=a.view,b;c.$body.addClass("editable");c.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");c.$editorContainer.find("form").removeClass("disabled");d.editable=true;b=L.marker([d.stopSelected.geom.lat,d.stopSelected.geom.lon],{icon:e,draggable:true});b.on("dragend",function(g){var f=g.target.getLatLng();a("#lat").val(f.lat);a("#lon").val(f.lng)});d.mapLayers.edit.addLayer(b);this.fillEditor(d.stopSelected);d.map.closePopup()},fillEditor:function(d){var e=a.sm.helpers;a("#name").val(d.name);a("#id").val(d.id).attr("disabled","disabled");a("#lat").val(d.geom.lat);a("#lon").val(d.geom.lon);for(var c=0,f=d.routes.length;c<f;c+=1){a("#routes").addTag(d.routes[c].name)}for(var c=0,b=d.types.length;c<b;c+=1){a("#stype_"+d.types[c].id).prop("checked",true)}a("#is_shelter").val(d.is_shelter);a("#is_bench").val(d.is_bench);a("#pan_link").val(e.valueNullToString(d.panorama_link));a("#comment").val(e.valueNullToString(d.comment));a("#is_check").val(d.is_check)},finishEditing:function(){var c=a.view.$document,d=a.viewmodel,b=a.view;d.mapLayers.edit.clearLayers();d.editable=false;b.$body.addClass("editable");b.$editorContainer.find("input, textarea").val("");b.$editorContainer.find("input:checkbox").prop("checked",false);b.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled");b.$editorContainer.find("form").addClass("disabled");a("#routes").importTags("");c.trigger("/sm/osm/updateOsmLayer");c.trigger("/sm/stops/updateStops")}})})(jQuery);(function(a){a.extend(a.viewmodel,{osmStops:{}});a.extend(a.view,{});a.sm.osm={};a.extend(a.sm.osm,{osmMaxClusterRadius:80,init:function(){this.setDomOptions();this.buildOsmStopsLayer();this.updateStopsFromXapi();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/osm/updateOsmLayer",function(d,c){b.updateOsmLayer(c)});a.viewmodel.map.on("zoomend",function(c){a.view.$document.trigger("/sm/osm/updateOsmLayer")})},setDomOptions:function(){},buildOsmStopsLayer:function(){var b=new L.layerGroup();a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.osmStops=b},updateOsmLayer:function(){var b=this.validateZoom();a.viewmodel.mapLayers.osmStops.clearLayers();if(!b){return}this.updateStopsFromXapi()},offOsmLayer:function(){a.viewmodel.mapLayers.osmStops.clearLayers()},onOsmLayer:function(){this.updateOsmLayer(false)},renderStops:function(e){var j=e.elements,h=a.viewmodel,b=h.mapLayers.osmStops,g=a.sm.map.getIcon("osm-bus-stop",16),d;for(var f=0,c=j.length;f<c;f++){h.osmStops[j[f].id]=j[f];d=L.marker([j[f].lat,j[f].lon],{icon:g}).on("click",function(n){a.view.$document.trigger("/sm/map/MarkerClick");var k=n.target,m=a.viewmodel.osmStops[k.id_osm],l=a.templates.osmPopupTemplate({tags:a.sm.helpers.hashToArrayKeyValues(m.tags),id:m.id,link:"http://www.openstreetmap.org/browse/node/"+m.id});k.bindPopup(l,{autoPan:false});a.view.$document.trigger("/sm/map/openPopup",[k])});d.id_osm=j[f].id;b.addLayer(d)}},updateStopsFromXapi:function(){var c=this,b=c.getApiUrl(a.viewmodel.map.getBounds());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},getApiUrl:function(d){var b=d.getSouthWest(),e=d.getNorthEast(),c="http://overpass-api.de/api/interpreter?data=[out:json];(node[highway=bus_stop]("+b.lat+","+b.lng+","+e.lat+","+e.lng+");>;);out;";return c},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{stopSelected:null});a.extend(a.view,{});a.sm.stops={};a.extend(a.sm.stops,{init:function(){this.setDomOptions();this.buildStopsLayers();this.updateStops();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/stops/updateStops",function(d,c){b.updateStops(c)})},setDomOptions:function(){},buildStopsLayers:function(){var c=new L.layerGroup(),b=new L.layerGroup();a.viewmodel.map.addLayer(c);a.viewmodel.mapLayers.stops=c;a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.edit=b},updateStops:function(){var b=this.validateZoom();a.viewmodel.mapLayers.stops.clearLayers();if(!b){return}this.updateStopsByAjax()},updateStopsByAjax:function(){var c=this,b=document.url_root+"stops?bbox="+JSON.stringify(a.viewmodel.get_bbox());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},renderStops:function(g){var d=a.sm.map,e=a.viewmodel,k=e.mapLayers.stops,l=d.getIcon("stop-block",20),h=d.getIcon("stop-edit",20),b,j,f,c;b=g.stops.block;for(j in b){if(b.hasOwnProperty(j)){c=a.templates.stopPopup({css:"block"});f=L.marker([b[j].lat,b[j].lon],{icon:h}).bindPopup(c,{autoPan:false}).off("click").on("click",function(m){a.view.$document.trigger("/sm/map/openPopup",[f])});k.addLayer(f)}}b=g.stops.non_block.non_check;for(j in b){if(b.hasOwnProperty(j)){f=L.marker([b[j].lat,b[j].lon],{icon:h}).on("click",function(n){a.view.$document.trigger("/sm/map/MarkerClick");var m=n.target;m.bindPopup(a.templates.stopPopupTemplate({css:"edit"}),{autoPan:false});a.view.$document.off("/sm/map/openPopupEnd").on("/sm/map/openPopupEnd",function(){a.getJSON(document.url_root+"stop/"+n.target.stop_id,function(q){a.viewmodel.stopSelected=q.stop;var p=a.sm.helpers,o=a.templates.stopPopupInfoTemplate({id:q.stop.id,name:q.stop.name,is_shelter:p.boolToString(q.stop.is_shelter),is_bench:p.boolToString(q.stop.is_bench),stop_type_id:p.valueNullToString(q.stop.stop_type_id),routes:q.stop.routes,types:q.stop.types,is_check:p.valueCheckToString(q.stop.is_check),comment:p.valueNullToString(q.stop.comment),isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable});a("#stop-popup").removeClass("loader").empty().append(o);a("button#edit").off("click").on("click",function(r){a.view.$document.trigger("/sm/editor/startEdit")})}).error(function(){a("#stop-popup").removeClass("loader").empty().append("Error connection")})});a.view.$document.trigger("/sm/map/openPopup",[m])});f.stop_id=j;k.addLayer(f)}}},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{isAuth:false});a.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.sm.user={};a.extend(a.sm.user,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var b=this;a.view.$signInForm.find("button").off("click").on("click",function(){b.authorize()});a.view.$signOutForm.find("button").off("click").on("click",function(){b.signOut()})},setDomOptions:function(){a.view.$userContainer=a("#userContainer");a.view.$signInForm=a("#signInForm");a.view.$signOutForm=a("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},updateUserUI:function(){a.view.$userContainer.toggleClass("inner",a.viewmodel.isAuth)},authorize:function(){var b=this;a.post(document.url_root+"user/login",{em:a("#em").val(),p:a("#p").val()},null,"json").done(function(c){a("#display-name").text(c.name);a.viewmodel.isAuth=true;b.updateUserUI()}).fail(function(d,e,c){alert(d.status);a.viewmodel.isAuth=false;b.updateUserUI()})},signOut:function(){var b=this;a.viewmodel.isAuth=false;a.post(document.url_root+"user/logout").done(function(){b.updateUserUI();a("#display-name").text("")})}})})(jQuery);