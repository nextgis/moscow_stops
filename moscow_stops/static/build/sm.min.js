(function(c){var b=new Array();var a=new Array();c.fn.doAutosize=function(f){var k=c(this).data("minwidth"),p=c(this).data("maxwidth"),g="",m=c(this),e=c("#"+c(this).data("tester_id"));if(g===(g=m.val())){return}var l=g.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");e.html(l);var n=e.width(),h=(n+f.comfortZone)>=k?n+f.comfortZone:k,d=m.width(),j=(h<d&&h>=k)||(h>k&&h<p);if(j){m.width(h)}};c.fn.resetAutosize=function(f){var e=c(this).data("minwidth")||f.minInputWidth||c(this).width(),j=c(this).data("maxwidth")||f.maxInputWidth||(c(this).closest(".tagsinput").width()-f.inputPadding),k="",d=c(this),g=c("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:d.css("fontSize"),fontFamily:d.css("fontFamily"),fontWeight:d.css("fontWeight"),letterSpacing:d.css("letterSpacing"),whiteSpace:"nowrap"}),h=c(this).attr("id")+"_autosize_tester";if(!c("#"+h).length>0){g.attr("id",h);g.appendTo("body")}d.data("minwidth",e);d.data("maxwidth",j);d.data("tester_id",h);d.css("width",e)};c.fn.addTag=function(e,d){d=jQuery.extend({focus:false,callback:true,css_class:"tag"},d);this.each(function(){var l=c(this).attr("id");var j=c(this).val().split(b[l]);if(j[0]==""){j=new Array()}e=jQuery.trim(e);if(d.unique){var g=c(this).tagExist(e);if(g==true){c("#"+l+"_tag").addClass("not_valid")}}else{var g=false}if(e!=""&&g!=true){c("<span>").addClass(d.css_class).append(c("<span>").text(e).append("&nbsp;&nbsp;"),c("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return c("#"+l).removeTag(escape(e))})).insertBefore("#"+l+"_addTag");j.push(e);c("#"+l+"_tag").val("");if(d.focus){c("#"+l+"_tag").focus()}else{c("#"+l+"_tag").blur()}c.fn.tagsInput.updateTagsField(this,j);if(d.callback&&a[l]&&a[l]["onAddTag"]){var k=a[l]["onAddTag"];k.call(this,e)}if(a[l]&&a[l]["onChange"]){var h=j.length;var k=a[l]["onChange"];k.call(this,c(this),j[h-1])}}});return false};c.fn.removeTag=function(d){d=unescape(d);this.each(function(){var h=c(this).attr("id");var e=c(this).val().split(b[h]);c("#"+h+"_tagsinput .tag").remove();str="";for(i=0;i<e.length;i++){if(e[i]!=d){str=str+b[h]+e[i]}}c.fn.tagsInput.importTags(this,str);if(a[h]&&a[h]["onRemoveTag"]){var g=a[h]["onRemoveTag"];g.call(this,d)}});return false};c.fn.tagExist=function(e){var f=c(this).attr("id");var d=c(this).val().split(b[f]);return(jQuery.inArray(e,d)>=0)};c.fn.importTags=function(d){id=c(this).attr("id");c("#"+id+"_tagsinput .tag").remove();c.fn.tagsInput.importTags(this,d)};c.fn.tagsInput=function(d){var e=jQuery.extend({interactive:true,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:false},hide:true,delimiter:",",unique:true,removeWithBackspace:true,placeholderColor:"#666666",autosize:true,comfortZone:20,inputPadding:6*2},d);this.each(function(){if(e.hide){c(this).hide()}var h=c(this).attr("id");if(!h||b[c(this).attr("id")]){h=c(this).attr("id","tags"+new Date().getTime()).attr("id")}var g=jQuery.extend({pid:h,real_input:"#"+h,holder:"#"+h+"_tagsinput",input_wrapper:"#"+h+"_addTag",fake_input:"#"+h+"_tag"},e);b[h]=g.delimiter;if(e.onAddTag||e.onRemoveTag||e.onChange){a[h]=new Array();a[h]["onAddTag"]=e.onAddTag;a[h]["onRemoveTag"]=e.onRemoveTag;a[h]["onChange"]=e.onChange}var f='<div id="'+h+'_tagsinput" class="tagsinput"><div id="'+h+'_addTag">';if(e.interactive){f=f+'<input id="'+h+'_tag" value="" data-default="'+e.defaultText+'" />'}f=f+'</div><div class="tags_clear"></div></div>';c(f).insertAfter(this);c(g.holder).css("width",e.width);c(g.holder).css("min-height",e.height);c(g.holder).css("height","100%");if(c(g.real_input).val()!=""){c.fn.tagsInput.importTags(c(g.real_input),c(g.real_input).val())}if(e.interactive){c(g.fake_input).val(c(g.fake_input).attr("data-default"));c(g.fake_input).css("color",e.placeholderColor);c(g.fake_input).resetAutosize(e);c(g.holder).bind("click",g,function(j){c(j.data.fake_input).focus()});c(g.fake_input).bind("focus",g,function(j){if(c(j.data.fake_input).val()==c(j.data.fake_input).attr("data-default")){c(j.data.fake_input).val("")}c(j.data.fake_input).css("color","#000000")});if(e.autocomplete_url!=undefined){autocomplete_options={source:e.autocomplete_url};for(attrname in e.autocomplete){autocomplete_options[attrname]=e.autocomplete[attrname]}if(jQuery.Autocompleter!==undefined){c(g.fake_input).autocomplete(e.autocomplete_url,e.autocomplete);c(g.fake_input).bind("result",g,function(j,l,k){if(l){c("#"+h).addTag(l[0]+"",{focus:true,unique:(e.unique)})}})}else{if(jQuery.ui.autocomplete!==undefined){c(g.fake_input).autocomplete(autocomplete_options);c(g.fake_input).bind("autocompleteselect",g,function(j,k){c(j.data.real_input).addTag(k.item.value,{focus:true,unique:(e.unique)});return false})}}}else{c(g.fake_input).bind("blur",g,function(j){var k=c(this).attr("data-default");if(c(j.data.fake_input).val()!=""&&c(j.data.fake_input).val()!=k){if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}}else{c(j.data.fake_input).val(c(j.data.fake_input).attr("data-default"));c(j.data.fake_input).css("color",e.placeholderColor)}return false})}c(g.fake_input).bind("keypress",g,function(j){if(j.which==j.data.delimiter.charCodeAt(0)||j.which==13){j.preventDefault();if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}c(j.data.fake_input).resetAutosize(e);return false}else{if(j.data.autosize){c(j.data.fake_input).doAutosize(e)}}});g.removeWithBackspace&&c(g.fake_input).bind("keydown",function(k){if(k.keyCode==8&&c(this).val()==""){k.preventDefault();var j=c(this).closest(".tagsinput").find(".tag:last").text();var l=c(this).attr("id").replace(/_tag$/,"");j=j.replace(/[\s]+x$/,"");c("#"+l).removeTag(escape(j));c(this).trigger("focus")}});c(g.fake_input).blur();if(g.unique){c(g.fake_input).keydown(function(j){if(j.keyCode==8||String.fromCharCode(j.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){c(this).removeClass("not_valid")}})}}});return this};c.fn.tagsInput.updateTagsField=function(e,d){var f=c(e).attr("id");c(e).val(d.join(b[f]))};c.fn.tagsInput.importTags=function(g,h){c(g).val("");var j=c(g).attr("id");var d=h.split(b[j]);for(i=0;i<d.length;i++){c(g).addTag(d[i],{focus:false,callback:false})}if(a[j]&&a[j]["onChange"]){var e=a[j]["onChange"];e.call(g,g,d[i])}}})(jQuery);
/*
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(m){var j=this,n=a.isFunction(a.Deferred)?a.Deferred():0,l=a.isFunction(n.notify),f=j.find("img").add(j.filter("img")),g=[],o=[],d=[];if(a.isPlainObject(m)){a.each(m,function(p,q){if(p==="callback"){m=q}else{if(n){n[p](q)}}})}function k(){var p=a(o),q=a(d);if(n){if(d.length){n.reject(f,p,q)}else{n.resolve(f)}}if(a.isFunction(m)){m.call(j,f,p,q)}}function e(p){h(p.target,p.type==="error")}function h(p,q){if(p.src===c||a.inArray(p,g)!==-1){return}g.push(p);if(q){d.push(p)}else{o.push(p)}a.data(p,"imagesLoaded",{isBroken:q,src:p.src});if(l){n.notifyWith(a(p),[q,f,a(o),a(d)])}if(f.length===g.length){setTimeout(k);f.unbind(".imagesLoaded",e)}}if(!f.length){k()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(q,r){var s=r.src;var p=a.data(r,"imagesLoaded");if(p&&p.src===s){h(r,p.isBroken);return}if(r.complete&&r.naturalWidth!==b){h(r,r.naturalWidth===0||r.naturalHeight===0);return}if(r.readyState||r.complete){r.src=c;r.src=s}})}return n?n.promise(j):j}})(jQuery);L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(b,a){L.Util.setOptions(this,a);this._key=b;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(a,g,e){var c="";for(var d=e;d>0;d--){var f=0;var b=1<<(d-1);if((a&b)!=0){f+=1}if((g&b)!=0){f+=2}c=c+f}return c},getTileUrl:function(c,d){var d=this._getZoomForUrl();var b=this.options.subdomains,a=this.options.subdomains[Math.abs((c.x+c.y)%b.length)];return this._url.replace("{subdomain}",a).replace("{quadkey}",this.tile2quad(c.x,c.y,d)).replace("{culture}",this.options.culture)},loadMetadata:function(){var d=this;var b="_bing_metadata_"+L.Util.stamp(this);window[b]=function(g){d.meta=g;window[b]=undefined;var f=document.getElementById(b);f.parentNode.removeChild(f);if(g.errorDetails){alert("Got metadata"+g.errorDetails);return}d.initMetadata()};var a="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+b+"&key="+this._key;var c=document.createElement("script");c.type="text/javascript";c.src=a;c.id=b;document.getElementsByTagName("head")[0].appendChild(c)},initMetadata:function(){var e=this.meta.resourceSets[0].resources[0];this.options.subdomains=e.imageUrlSubdomains;this._url=e.imageUrl;this._providers=[];for(var d=0;d<e.imageryProviders.length;d++){var f=e.imageryProviders[d];for(var b=0;b<f.coverageAreas.length;b++){var h=f.coverageAreas[b];var g={zoomMin:h.zoomMin,zoomMax:h.zoomMax,active:false};var a=new L.LatLngBounds(new L.LatLng(h.bbox[0]+0.01,h.bbox[1]+0.01),new L.LatLng(h.bbox[2]-0.01,h.bbox[3]-0.01));g.bounds=a;g.attrib=f.attribution;this._providers.push(g)}}this._update()},_update:function(){if(this._url==null||!this._map){return}this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var a=this._map.getBounds();var c=this._map.getZoom();for(var b=0;b<this._providers.length;b++){var d=this._providers[b];if((c<=d.zoomMax&&c>=d.zoomMin)&&a.intersects(d.bounds)){if(!d.active){this._map.attributionControl.addAttribution(d.attrib)}d.active=true}else{if(d.active){this._map.attributionControl.removeAttribution(d.attrib)}d.active=false}}},onRemove:function(c){for(var a=0;a<this._providers.length;a++){var b=this._providers[a];if(b.active){this._map.attributionControl.removeAttribution(b.attrib);b.active=false}}L.TileLayer.prototype.onRemove.apply(this,[c])}});
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var n={};n.name="mustache.js";n.version="0.7.2";n.tags=["{{","}}"];n.Scanner=s;n.Context=u;n.Writer=v;var d=/\s*/;var a=/\s+/;var b=/\S/;var g=/\s*=/;var o=/\s*\}/;var r=/#|\^|\/|>|\{|&|=|!/;var j=RegExp.prototype.test;var q=Object.prototype.toString;function w(z,y){return j.call(z,y)}function e(y){return !w(b,y)}var l=Array.isArray||function(y){return q.call(y)==="[object Array]"};function f(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function x(y){return String(y).replace(/[&<>"'\/]/g,function(z){return h[z]})}n.escape=x;function s(y){this.string=y;this.tail=y;this.pos=0}s.prototype.eos=function(){return this.tail===""};s.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};s.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function u(y,z){this.view=y;this.parent=z;this._cache={}}u.make=function(y){return(y instanceof u)?y:new u(y)};u.prototype.push=function(y){return new u(y,this)};u.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function v(){this.clearCache()}v.prototype.clearCache=function(){this._cache={};this._partialCache={}};v.prototype.compile=function(y,z){var A=this._cache[y];if(!A){var B=n.parse(y,z);A=this._cache[y]=this.compileTokens(B,y)}return A};v.prototype.compilePartial=function(A,y,z){var B=this.compile(y,z);this._partialCache[A]=B;return B};v.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};v.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return p(A,y,u.make(B),z)}};v.prototype.render=function(z,y,A){return this.compile(z)(y,A)};function p(y,E,z,I){var B="";var A,G,H;for(var D=0,F=y.length;D<F;++D){A=y[D];G=A[1];switch(A[0]){case"#":H=z.lookup(G);if(typeof H==="object"){if(l(H)){for(var C=0,K=H.length;C<K;++C){B+=p(A[4],E,z.push(H[C]),I)}}else{if(H){B+=p(A[4],E,z.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(z.view,J,function(M){return E.render(M,z)});if(H!=null){B+=H}}else{if(H){B+=p(A[4],E,z,I)}}}break;case"^":H=z.lookup(G);if(!H||(l(H)&&H.length===0)){B+=p(A[4],E,z,I)}break;case">":H=E.getPartial(G);if(typeof H==="function"){B+=H(z)}break;case"&":H=z.lookup(G);if(H!=null){B+=H}break;case"name":H=z.lookup(G);if(H!=null){B+=n.escape(H)}break;case"text":B+=G;break}}return B}function m(F){var z=[];var D=z;var E=[];var B;for(var A=0,y=F.length;A<y;++A){B=F[A];switch(B[0]){case"#":case"^":E.push(B);D.push(B);D=B[4]=[];break;case"/":var C=E.pop();C[5]=B[2];D=E.length>0?E[E.length-1][4]:z;break;default:D.push(B)}}return z}function k(D){var C=[];var B,z;for(var A=0,y=D.length;A<y;++A){B=D[A];if(B){if(B[0]==="text"&&z&&z[0]==="text"){z[1]+=B[1];z[3]=B[3]}else{z=B;C.push(B)}}}return C}function t(y){return[new RegExp(f(y[0])+"\\s*"),new RegExp("\\s*"+f(y[1]))]}n.parse=function(G,F){G=G||"";F=F||n.tags;if(typeof F==="string"){F=F.split(a)}if(F.length!==2){throw new Error("Invalid tags: "+F.join(", "))}var O=t(F);var C=new s(G);var H=[];var Q=[];var z=[];var E=false;var P=false;function J(){if(E&&!P){while(z.length){delete Q[z.pop()]}}else{z=[]}E=false;P=false}var B,A,I,K,D;while(!C.eos()){B=C.pos;I=C.scanUntil(O[0]);if(I){for(var M=0,N=I.length;M<N;++M){K=I.charAt(M);if(e(K)){z.push(Q.length)}else{P=true}Q.push(["text",K,B,B+1]);B+=1;if(K=="\n"){J()}}}if(!C.scan(O[0])){break}E=true;A=C.scan(r)||"name";C.scan(d);if(A==="="){I=C.scanUntil(g);C.scan(g);C.scanUntil(O[1])}else{if(A==="{"){I=C.scanUntil(new RegExp("\\s*"+f("}"+F[1])));C.scan(o);C.scanUntil(O[1]);A="&"}else{I=C.scanUntil(O[1])}}if(!C.scan(O[1])){throw new Error("Unclosed tag at "+C.pos)}D=[A,I,B,C.pos];Q.push(D);if(A==="#"||A==="^"){H.push(D)}else{if(A==="/"){if(H.length===0){throw new Error('Unopened section "'+I+'" at '+B)}var y=H.pop();if(y[1]!==I){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(A==="name"||A==="{"||A==="&"){P=true}else{if(A==="="){F=I.split(a);if(F.length!==2){throw new Error("Invalid tags at "+B+": "+F.join(", "))}O=t(F)}}}}}var y=H.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+C.pos)}Q=k(Q);return m(Q)};var c=new v();n.clearCache=function(){return c.clearCache()};n.compile=function(y,z){return c.compile(y,z)};n.compilePartial=function(A,y,z){return c.compilePartial(A,y,z)};n.compileTokens=function(z,y){return c.compileTokens(z,y)};n.render=function(z,y,A){return c.render(z,y,A)};n.to_html=function(z,y,A,C){var B=n.render(z,y,A);if(typeof C==="function"){C(B)}else{return B}};return n}())));(function(a){a.sm={};a.viewmodel={};a.view={};a.templates={};a.extend(a.viewmodel,{version:null});a.extend(a.view,{$document:null});a.sm.loader={};a.extend(a.sm.loader,{templates:["osmPopupTemplate","stopPopupTemplate","stopPopupInfoTemplate","searchResultsTemplate","userLogsTemplate"],init:function(){this.setDomOptions();this.compileTemplates()},initModules:function(){try{a.sm.common.init();a.sm.map.init();a.sm.searcher.init();a.sm.editor.init();a.sm.osm.init();a.sm.user.init();a.sm.stops.init()}catch(b){alert(b)}},setDomOptions:function(){a.view.$document=a(document)},compileTemplates:function(){var g=this,c=[],f=[],d=[],b,e=this.templates.length;for(b=0;b<e;b++){c.push(a.get(document.url_root+"static/js/templates/"+this.templates[b]+".htm",function(k,j,h){d.push({name:this.url.substr((this.url.lastIndexOf("/")+1)).replace(".htm",""),html:h.responseText})}))}a.when.apply(null,c).done(function(){for(b=0;b<e;b++){var h=d[b].name;a.templates[h]=Mustache.compile(d[b].html)}window.setTimeout(function(){g.initModules();a("img").imagesLoaded(function(){a.view.$body.removeClass("loading")})},1000)})}});a(document).ready(function(){a.sm.loader.init()})})(jQuery);(function(a){a.sm.helpers={};a.extend(a.sm.helpers,{getIcon:function(b,c){return L.divIcon({className:b,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})},hashToArrayKeyValues:function(c){var b=[];if(Object.prototype.toString.call(c)==="[object Array]"){return c}for(var d in c){if(!c.hasOwnProperty(d)){continue}b.push({key:d,val:c[d]})}return b},boolToString:function(c,b){switch(c){case null:return b?"null":"";break;case true:return b?"true":"Да";break;case false:return b?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(b){if(b===null){return""}return b},valueCheckToString:function(b){switch(b){case 0:return"Не нужна";break;case 1:return"Нужна";break;case 2:return"Проверена";break;case 3:return"Проверена по Бингу";break;default:return"Не нужна";break}},sortByFields:function(){var c=arguments,b=this;return function(h,g){var d=0,f=0,e=c.length;while(f===0&&d<e){f=b.dynamicSort(c[d])(h,g);d++}return f}},dynamicSort:function(b){var c=1;if(b[0]==="-"){c=-1;b=b.substr(1,b.length-1)}return function(e,d){var f=(e[b]<d[b])?-1:(e[b]>d[b])?1:0;return f*c}}})})(jQuery);(function(a){a.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});a.extend(a.view,{$body:null,$popup:null});a.sm.common={};a.extend(a.sm.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/common/openPopup",function(f,d,c){b.openPopup(d,c)});a.view.$popup.find("a.close").off("click").on("click",function(){a.view.$body.removeClass("popup")});a.view.$document.on("/sm/common/setMainLoad",function(){a.view.$body.addClass("loader")})},openPopup:function(e,c){var f=a.view.$popup,d,b;f.find("div.header").text(e);f.find("div.content").html(c);d=f.width()/2;b=f.height()/2;f.css({"margin-left":-d+"px","margin-top":-b+"px"});a.view.$body.addClass("popup")},closePopup:function(){},setDomOptions:function(){a.view.$body=a("body");a.view.$popup=a("#popup")}})})(jQuery);(function(a){a.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});a.extend(a.view,{$map:null});a.sm.map={};a.extend(a.sm.map,{init:function(){this.buildMap();this.buildLayerManager();this.bindEvents()},bindEvents:function(){var b=this;a.viewmodel.map.on("moveend",function(d){var c=d.target;a.view.$document.trigger("/sm/map/updateAllLayers");b.manageOsmLayer();b.setLastExtent(c.getCenter(),c.getZoom())});a.view.$document.on("/sm/map/updateAllLayers",function(){a.view.$document.trigger("/sm/map/validate");a.view.$document.trigger("/sm/stops/updateStops");a.view.$document.trigger("/sm/osm/updateOsmLayer")});a.view.$document.on("/sm/map/openPopup",function(j,h,d){var f=a.viewmodel,c=f.mapLayers.select,g=f.map;g.panTo(h);g.openPopup(L.popup().setLatLng(h).setContent(d))});a.viewmodel.map.on("popupclose",function(){var c=a.viewmodel;c.isPopupOpened=false;c.mapLayers.select.clearLayers()})},buildMap:function(){var d=this,e=a.viewmodel,c=L.layerGroup(),b=this.getLastExtent();a.view.$map=a("#map");e.map=new L.Map("map");L.control.scale().addTo(e.map);if(b){e.map.setView(b.latlng,b.zoom)}else{e.map.setView(new L.LatLng(55.742,37.658),14);this.setLastExtent(new L.LatLng(55.742,37.658),14)}e.map.addLayer(c);e.mapLayers.select=c},getLastExtent:function(){var d=parseFloat(a.cookie("map.lat"),10),b=parseFloat(a.cookie("map.lng"),10),c=parseInt(a.cookie("map.zoom"),10);if(d&&b&&c){return{latlng:new L.LatLng(d,b),zoom:c}}else{return null}},setLastExtent:function(b,c){a.cookie("map.lat",b.lat,{expires:7,path:"/"});a.cookie("map.lng",b.lng,{expires:7,path:"/"});a.cookie("map.zoom",c,{expires:7,path:"/"})}})})(jQuery);(function(a){a.extend(a.sm.map,{getIcon:function(c,d,b){return L.divIcon({className:c,iconSize:[d,d],iconAnchor:[d/2,d/2],popupAnchor:[0,2-(d/2)],html:b})}})})(jQuery);(function(a){a.extend(a.viewmodel,{currentTileLayer:null});a.extend(a.view,{$tileLayers:null,$manager:null,isLabelsButtonOn:false});a.extend(a.sm.map,{_layers:{},_lastIndex:0,layersName:{osm:"osm",osm19:"osm_19",bing:"bing"},buildLayerManager:function(){var b=a.view;a.view.$manager=a("#manager");this.buildLabelsButton();this.addTileLayer(this.layersName.osm,"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors",8,18,"osm");this.addTileLayer(this.layersName.osm19,"http://nextgis.ru/data/moscow-stops/Tiles/moscow-stops/{z}/{x}/{y}.png","© OpenStreetMap contributors",19,19,"osm");this.addBingLayer("AujH--7B6FRTK8b81QgPhuvw_Sb3kc8hBO-Lp5OLNyhCD4ZQoGGW4cQS6zBgaeEh");a.view.$tileLayers=b.$map.find("div.leaflet-tile-pane div.leaflet-layer");this.bindLayerManagerEvents();this.onLayer("osm");this.manageOsmLayer()},buildLabelsButton:function(){a.view.$body.toggleClass("no-button-labels",a.viewmodel.map.getZoom()<=15)},bindLayerManagerEvents:function(){var b=this;a.viewmodel.map.off("zoomend").on("zoomend",function(){b.onLayer();b.validateLabelsRendering()});a.view.$manager.find("div.tile-layers div.icon").off("click").on("click",function(d){var c=a(this).data("layer");if(c===b.layersName.osm){b.onLayer(c);b.manageOsmLayer()}else{b.onLayer(c)}});a("#labelsButton").off("click").on("click",function(d){var f=a.viewmodel,c=!f.isRenderedLabels;a.view.$body.toggleClass("labels",c);f.isRenderedLabels=c;f.isLabelsMode=!f.isLabelsMode;a.view.$document.trigger("/sm/stops/updateStops")});a.view.$document.on("/sm/map/validate",function(){b.validateLabelsRendering()})},onLayer:function(d){var c=a.viewmodel;if(c.currentTileLayer==d){return false}var b=a.view,e=a(a.viewmodel.map.getPanes().tilePane).find("div.leaflet-layer");if(d){if(c.currentTileLayer){b.$body.removeClass(this._layers[c.currentTileLayer].css).addClass(this._layers[d].css)}else{b.$body.addClass(this._layers[d].css)}c.currentTileLayer=d;e.hide().eq(this._layers[d].index).show()}else{e.hide().eq(this._layers[c.currentTileLayer].index).show()}},addTileLayer:function(g,c,f,h,b,e){var d=new L.TileLayer(c,{minZoom:h,maxZoom:b,attribution:f});this._layers[g]={layer:a.viewmodel.map.addLayer(d,true),index:this._lastIndex,css:e||g};this._lastIndex+=1},addBingLayer:function(c){var b=new L.BingLayer(c,{minZoom:8,maxZoom:19});this._layers.bing={layer:a.viewmodel.map.addLayer(b,true),index:this._lastIndex,css:this.layersName.bing};this._lastIndex+=1},manageOsmLayer:function(){var c=a.viewmodel,b=this.layersName,d=c.map.getZoom();if(d>18&&c.currentTileLayer===b.osm){this.onLayer(b.osm19)}if(d<=18&&c.currentTileLayer===b.osm19){this.onLayer(b.osm)}return true},validateLabelsRendering:function(){var c=a.viewmodel.isRenderedLabels,b=a.view.isLabelsButtonOn,d=a.viewmodel.map.getZoom();this.buildLabelsButton();a.viewmodel.isRenderedLabels=d>=16}})})(jQuery);(function(a){a.extend(a.viewmodel,{searcherCollapsed:false,filter:{id:"",name:"",is_help:""},isFilterValidated:true});a.extend(a.view,{$searchContainer:null,$filterName:null,$filterId:null,$filterIsHelp:null,$searchButton:null,$searchResults:null});a.sm.searcher={};a.extend(a.sm.searcher,{min_characters_name:3,init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this,b=a.view;b.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",c.searcherCollapsed)});b.$filterName.off("keyup").on("keyup",function(d){c.keyUpHandler(d)});b.$filterId.off("keyup").on("keyup",function(d){c.keyUpHandler(d)});a("#filter_name, #filter_id").off("focus").on("focus",function(){a.view.$searchResults.prop("class","description")});a("#searchResults p.description").off("click").on("click",function(){a.view.$searchResults.prop("class","active")});b.$searchButton.off("click").on("click",function(){if(a.viewmodel.isFilterValidated){c.applyFilter()}});b.$document.on("/sm/searcher/update",function(){c.updateSearch()});b.$document.on("/sm/stops/startUpdate",function(){var d=a.view;d.$searchResults.prop("class","update");d.$filterName.prop("disabled",true);d.$filterId.prop("disabled",true)});b.$document.on("/sm/stops/endUpdate",function(){var d=a.view;d.$searchResults.prop("class","active");d.$filterName.prop("disabled",false);d.$filterId.prop("disabled",false)})},setDomOptions:function(){var b=a.view;b.$searchContainer=a("#searchContainer");b.$filterName=a("#filter_name");b.$filterId=a("#filter_id");b.$filterIsHelp=a("#filter_is_help");b.$searchButton=a("#search");b.$searchResults=a("#searchResults")},keyUpHandler:function(b){this.validateSearch();if(b.keyCode==13){this.applyFilter()}},validateSearch:function(){var e=/^\d+$/,f=this.min_characters_name,b=a.view,d=a.viewmodel,g=b.$filterId.val(),c=b.$filterName.val();if(c.length<=f&&c!=""){b.$filterName.addClass("invalid")}else{b.$filterName.removeClass("invalid")}if(!e.test(g)&&g!=""){b.$filterId.addClass("invalid")}else{b.$filterId.removeClass("invalid")}if((c.length>f&&g=="")||((c==""||c.length<=f)&&e.test(g))||(c.length>f&&e.test(g))||(c==""&&g=="")){d.isFilterValidated=true}else{d.isFilterValidated=false}a.view.$searchButton.toggleClass("active",a.viewmodel.isFilterValidated)},applyFilter:function(){if(a.viewmodel.isFilterValidated){this.updateFilter();this.search()}},updateFilter:function(){var c=a.view,b=a.viewmodel;b.filter.name=c.$filterName.val();b.filter.id=c.$filterId.val();b.filter.is_help=c.$filterIsHelp.is(":checked")},search:function(){a.view.$document.trigger("/sm/stops/updateStops")},updateSearch:function(){var d=a.viewmodel.stops,c=a.view.$searchResults.find("div"),b;b=this.getHtmlForSearchResults("non_check",d.non_block.non_check.elements);b+=this.getHtmlForSearchResults("check",d.non_block.check.elements);b+=this.getHtmlForSearchResults("block",d.block.elements);c.empty().append(b);c.find("a").on("click",function(){var e=a(this).parent();a.viewmodel.map.setView(new L.LatLng(e.data("lat"),e.data("lon")),18);a("#target").show().delay(1000).fadeOut(1000)});a.view.$searchResults.prop("class","active")},getHtmlForSearchResults:function(c,b){return a.templates.searchResultsTemplate({cssClass:c,stops:b})}})})(jQuery);(function(a){a.extend(a.viewmodel,{editorCollapsed:false,editable:false,routeTypeSelected:null});a.extend(a.view,{$editorContainer:null});a.sm.editor={};a.extend(a.sm.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},init:function(){this.setDomOptions();this.buildTags();this.buildEditLayer();this.buildRoutesSelector();this.bindEvents()},bindEvents:function(){var b=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.editorCollapsed=!a.viewmodel.editorCollapsed;a.view.$body.toggleClass("editor-collapsed",b.editorCollapsed)});a("#pan_link").off("input").on("input",function(){b.validateLink()});a.view.$document.on("/sm/editor/startEdit",function(c){b.startAjaxEdition()});a("#save").off("click").on("click",function(c){c.stopPropagation();b.save()});a("#discard").off("click").on("click",function(c){c.stopPropagation();b.finishAjaxEdition()});a("#route_type").off("change").on("change",function(d){var c=d.target.value;a("#route_type_"+a.viewmodel.routeTypeSelected).hide();a("#route_type_"+c).show();a.viewmodel.routeTypeSelected=c});a("#add-route").off("click").on("click",function(c){var d=a("#route_type_"+a.viewmodel.routeTypeSelected).find(":selected");b.addRoute(d.val(),d.text())});a("#editorForm").find(":checkbox").off("click").on("click",function(){var d=a(this),c=a("#"+d.data("id"));if(d.is(":checked")){c.val(1)}else{c.val(0)}})},setDomOptions:function(){a.view.$editorContainer=a("#editorContainer")},buildTags:function(){var b=this;a("#routes").tagsInput({defaultText:"+",width:"185px",maxChars:5,interactive:false,onRemoveTag:function(c){b.removeRoute(c)}})},buildEditLayer:function(){var b=L.layerGroup();a.viewmodel.mapLayers.edit=a.viewmodel.map.addLayer(b)},buildRoutesSelector:function(){var b=a("#route_type").find(":selected").val();a("#route_type_"+b).show();a.viewmodel.routeTypeSelected=b},validateLink:function(){var b=a("#pan_link_a"),c=a("#pan_link").val();if(this.regex.url.test(c)){b.attr("class","active").prop("href",c)}else{b.removeAttr("href").attr("class","")}},save:function(){var d=this,j=a("#editorContainer form"),e=j.serializeArray(),f=0,g=e.length,k=a.viewmodel.stopSelected,c=document.url_root+"stop/"+k.id,h={id:k.id},b;for(f;f<g;f+=1){b=e[f].name;switch(b){case b==="lon":h.geom["lon"]=e[f].value;break;case b==="lat":h.geom["lat"]=e[f].value;break;default:h[e[f].name]=e[f].value;break}}h.routes=this.getRoutesToSave(k);h.stop_types=this.getStopTypes(k);a.ajax({type:"POST",url:c,data:{stop:JSON.stringify(h)}}).done(function(){d.finishAjaxEdition()})},getRoutesToSave:function(e){var f=e.routes.routes,c=f.length,b=e.id,d=0,g=[];for(d;d<c;d+=1){g.push({stop_id:b,route_id:f[d].id})}return g},getStopTypes:function(c){var b=c.id;if(a("#stype_0").is(":checked")){return[{stop_id:b,stop_type_id:0}]}else{var d=[];a("#types .parameter.sub input:checked").each(function(){d.push({stop_id:b,stop_type_id:a(this).data("id")})});return d}},startAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/block/"+a.viewmodel.stopSelected.id}).done(function(){b.startEdit()})},startEdit:function(){var d=a.sm.helpers.getIcon("stop-editable",25),c=a.viewmodel,b=a.view,e;b.$body.addClass("editable");b.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");b.$editorContainer.find("form").removeClass("disabled");c.editable=true;e=L.marker([c.stopSelected.geom.lat,c.stopSelected.geom.lon],{icon:d,draggable:true});e.on("dragend",function(g){var f=g.target.getLatLng();a("#lat").val(f.lat);a("#lon").val(f.lng)});c.mapLayers.edit.addLayer(e);this.fillEditor(c.stopSelected);this.bindEventsForTypes();a("#chb_is_help").off("change").on("change",function(){if(this.checked){a("#is_help").val(1)}else{a("#is_help").val(0)}});c.map.closePopup()},bindEventsForTypes:function(){var b=a.view;a("#stype_0").off("change").on("change",function(){if(this.checked){a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}else{a("#types .parameters input").not("#stype_0").prop("disabled",false);a("#other_stype").prop("checked",true);a("#types .parameter.sub label").removeClass("disabled")}});a("#other_stype").off("change").on("change",function(){if(this.checked){a("#types .parameters input").prop("disabled",false);a("#stype_0").prop("checked",false);a("#types .parameter.sub label").removeClass("disabled")}else{a("#stype_0").prop("checked",true);a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}})},fillEditor:function(d){var e=a.sm.helpers;a("#name").val(d.name);a("#id").val(d.id).attr("disabled","disabled");a("#lat").val(d.geom.lat);a("#lon").val(d.geom.lon);this.fillRoutes(d.routes);for(var c=0,b=d.types.length;c<b;c+=1){a("#stype_"+d.types[c].id).prop("checked",true)}if(d.types.length>0&&d.types[0].id===0){a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}else{if(d.types.length>0&&d.types[0].id!==0){a("#types .parameters input").not("#stype_0").prop("disabled",false);a("#other_stype").prop("checked",true);a("#types .parameter.sub label").removeClass("disabled")}else{a("#types .parameter.sub label").addClass("disabled");a("#types .parameter.sub input").prop("disabled",true)}}a("#is_shelter").val(e.boolToString(d.is_shelter,true));a("#is_bench").val(e.boolToString(d.is_bench,true));a("#pan_link").val(e.valueNullToString(d.panorama_link));this.validateLink();a("#auto_link").prop("href",this.getPanoramaAutoLink(d.geom));a("#comment").val(e.valueNullToString(d.comment));a("#is_check").val(d.check_status_type_id);if(d.is_help){a("#is_help").val(1);a("#chb_is_help").prop("checked",true)}else{a("#is_help").val(0);a("#chb_is_help").prop("checked",false)}},getPanoramaAutoLink:function(b){var c=b.lon+","+b.lat;return"http://maps.yandex.ru/?ll="+c+"&spn=0.011795,0.004087&l=map,stv&ol=stv&oll="+c+"&ost=dir:0,0~spn:90,73.739795"},fillRoutes:function(f){var e=a.sm.helpers,b=f.sort(e.sortByFields("route_type_id","name")),d=0,c=b.length,g={ids:{},routes:b};for(d;d<c;d+=1){g.ids[b[d].id]=true;a("#routes").addTag(b[d].name,{css_class:"tag type-id-"+b[d].route_type_id})}a.viewmodel.stopSelected.routes=g},addRoute:function(f,b){var c=a.viewmodel,e=c.routeTypeSelected,d=c.stopSelected.routes;if(d.ids[f]){return false}else{d.ids[f]=true}d.routes.push({route_type_id:e,id:f,name:b});this.updateUIRoutes(d.routes)},removeRoute:function(b){var e=a.viewmodel,g=e.stopSelected.routes,f,d=0,c=g.routes.length;for(d;d<c;d+=1){if(g.routes[d].name===b){f=g.routes[d];g.ids[f.id]=false;g.routes.splice(d,1);break}}this.updateUIRoutes(g.routes)},updateUIRoutes:function(d){var c=0,b=d.length;d=d.sort(a.sm.helpers.sortByFields("route_type_id","name"));this.clearUIRoutes();for(c;c<b;c+=1){a("#routes").addTag(d[c].name,{css_class:"tag type-id-"+d[c].route_type_id})}},clearUIRoutes:function(){a("#routes").importTags("")},finishAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/unblock/"+a.viewmodel.stopSelected.id}).done(function(){b.finishEditing()})},finishEditing:function(){var c=a.view.$document,d=a.viewmodel,b=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;b.$body.addClass("editable");b.$editorContainer.find("input, textarea").val("");b.$editorContainer.find("input:checkbox").prop("checked",false);b.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled");b.$editorContainer.find("form").addClass("disabled");a("#auto_link").prop("href","");a("#routes").importTags("");a.view.$document.trigger("/sm/map/updateAllLayers")}})})(jQuery);(function(a){a.extend(a.viewmodel,{osmStops:{}});a.extend(a.view,{});a.sm.osm={};a.extend(a.sm.osm,{osmMaxClusterRadius:80,init:function(){this.setDomOptions();this.buildOsmStopsLayer();this.updateStopsFromXapi();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/osm/updateOsmLayer",function(){b.updateOsmLayer()})},setDomOptions:function(){},buildOsmStopsLayer:function(){var b=new L.layerGroup();a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.osmStops=b},updateOsmLayer:function(){var b=this.validateZoom();a.viewmodel.mapLayers.osmStops.clearLayers();if(!b){return}this.updateStopsFromXapi()},offOsmLayer:function(){a.viewmodel.mapLayers.osmStops.clearLayers()},onOsmLayer:function(){this.updateOsmLayer(false)},renderStops:function(b){var h=b.elements,e=a.viewmodel,j=e.mapLayers.osmStops,d=a.sm.map.getIcon("osm-bus-stop",16),g;e.osmStops={};popupHtml=a.templates.stopPopupTemplate({css:"block"});for(var c=0,f=h.length;c<f;c++){e.osmStops[h[c].id]=h[c];g=L.marker([h[c].lat,h[c].lon],{icon:d}).on("click",function(n){a.view.$document.trigger("/sm/map/MarkerClick");var m=n.target,l=a.viewmodel.osmStops[m.id_osm],k=a.templates.osmPopupTemplate({tags:a.sm.helpers.hashToArrayKeyValues(l.tags),id:l.id,link:"http://www.openstreetmap.org/browse/node/"+l.id});a.view.$document.trigger("/sm/map/openPopup",[m.getLatLng(),k])});g.id_osm=h[c].id;j.addLayer(g)}},updateStopsFromXapi:function(){var c=this,b=c.getApiUrl(a.viewmodel.map.getBounds());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},getApiUrl:function(c){var b=c.getSouthWest(),e=c.getNorthEast(),d="http://overpass-api.de/api/interpreter?data=[out:json];(node[highway=bus_stop]("+b.lat+","+b.lng+","+e.lat+","+e.lng+");>;);out;";return d},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{stopSelected:null,stopSelectedId:null,stops:null,isRenderedLabels:false,isLabelsMode:false});a.extend(a.view,{});a.sm.stops={};a.extend(a.sm.stops,{init:function(){this.setDomOptions();this.buildStopsLayers();this.updateStops();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/stops/updateStops",function(){b.updateStops()})},setDomOptions:function(){},buildStopsLayers:function(){var c=new L.layerGroup(),b=new L.layerGroup();a.viewmodel.map.addLayer(c);a.viewmodel.mapLayers.stops=c;a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.edit=b},updateStops:function(){var b=this.validateZoom();a.viewmodel.mapLayers.stops.clearLayers();if(!b){return}a.view.$document.trigger("/sm/stops/startUpdate");this.updateStopsByAjax()},updateStopsByAjax:function(){var d=this,c=document.url_root+"stops",b=a.viewmodel.filter;a.ajax({type:"GET",url:c,data:{bbox:JSON.stringify(a.viewmodel.map.getBounds()),filter:JSON.stringify(b)},dataType:"json",success:function(e){d.renderStops(e);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:d})},renderStops:function(h){var c=a.sm.map,l=a.viewmodel,o=l.isRenderedLabels,n,p=l.mapLayers.stops,k,b,e,m,f,j,g=a.templates.stopPopupTemplate({css:"edit"}),d=this;l.stops=h.stops;k=h.stops.block.elements;b=h.stops.block.count;for(e=0;e<b;e+=1){m=k[e];n=o?'<div class="marker-label">'+m.name+"</br>"+m.id+'</div><div class="pointer"></div>':null;f=L.marker([m.lat,m.lon],{icon:c.getIcon("stop-block",20,n)}).on("click",function(r){var q=r.target;a.view.$document.trigger("/sm/map/openPopup",[q.getLatLng(),g]);d.buildStopPopup(q.stop_id)});f.stop_id=m.id;p.addLayer(f)}k=h.stops.non_block.non_check.elements;b=h.stops.non_block.non_check.count;for(e=0;e<b;e+=1){m=k[e];n=o?'<div class="marker-label">'+m.name+"</br>"+m.id+'</div><div class="pointer"></div>':null;f=L.marker([m.lat,m.lon],{icon:c.getIcon("stop-edit",20,n)}).on("click",function(r){var q=r.target;a.view.$document.trigger("/sm/map/openPopup",[q.getLatLng(),g]);d.buildStopPopup(q.stop_id)});f.stop_id=m.id;p.addLayer(f)}k=h.stops.non_block.check.elements;b=h.stops.non_block.check.count;for(e=0;e<b;e+=1){m=k[e];n=o?'<div class="marker-label">'+m.name+"</br>"+m.id+'</div><div class="pointer"></div>':null;f=L.marker([m.lat,m.lon],{icon:c.getIcon("stop-check",20,n)}).on("click",function(r){var q=r.target;a.view.$document.trigger("/sm/map/openPopup",[q.getLatLng(),g]);d.buildStopPopup(q.stop_id)});f.stop_id=m.id;p.addLayer(f)}},buildStopPopup:function(b){return a.getJSON(document.url_root+"stop/"+b,function(e){if(!a.viewmodel.editable){a.viewmodel.stopSelected=e.stop}var c=a.sm.helpers,d=a.templates.stopPopupInfoTemplate({id:e.stop.id,name:e.stop.name,is_shelter:c.boolToString(e.stop.is_shelter),is_bench:c.boolToString(e.stop.is_bench),stop_type_id:c.valueNullToString(e.stop.stop_type_id),routes:e.stop.routes,types:e.stop.types,check_status:c.valueCheckToString(e.stop.check_status_type_id),comment:c.valueNullToString(e.stop.comment),isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable||e.stop.is_block,isBlock:e.stop.is_block,userBlock:e.stop.user_block,isUnBlock:e.stop.is_unblock});a("#stop-popup").removeClass("loader").empty().append(d);a("button#edit").off("click").on("click",function(f){a.view.$document.trigger("/sm/editor/startEdit")});if(e.stop.is_unblock){a("#unblock").off("click").on("click",function(f){a.ajax({type:"GET",url:document.url_root+"stop/unblock/"+a.viewmodel.stopSelected.id}).done(function(){a.viewmodel.map.closePopup();a.view.$document.trigger("/sm/map/updateAllLayers")})})}}).error(function(){a("#stop-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{isAuth:false});a.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.sm.user={};a.extend(a.sm.user,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$userContainer=a("#userContainer");a.view.$signInForm=a("#signInForm");a.view.$signOutForm=a("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},bindEvents:function(){var b=this;a("#signOutForm div.log").off("click").on("click",function(){b.renderLogs()})},renderLogs:function(){var b=document.url_root+"logs";a.view.$document.trigger("/sm/common/setMainLoad");a.ajax({type:"GET",url:b,dataType:"json",success:function(d){var c=a.templates.userLogsTemplate({user_logs:d.stops_by_users,count_all:d.count.all,count_editable:d.count.editable,percent:(d.count.editable/d.count.all*100).toFixed(2)});a.view.$body.removeClass("loader");a.view.$document.trigger("/sm/common/openPopup",["Статистика пользователей",c])}})}})})(jQuery);