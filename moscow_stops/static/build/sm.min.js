(function(c){var b=new Array();var a=new Array();c.fn.doAutosize=function(f){var k=c(this).data("minwidth"),p=c(this).data("maxwidth"),g="",m=c(this),e=c("#"+c(this).data("tester_id"));if(g===(g=m.val())){return}var l=g.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");e.html(l);var n=e.width(),h=(n+f.comfortZone)>=k?n+f.comfortZone:k,d=m.width(),j=(h<d&&h>=k)||(h>k&&h<p);if(j){m.width(h)}};c.fn.resetAutosize=function(f){var e=c(this).data("minwidth")||f.minInputWidth||c(this).width(),j=c(this).data("maxwidth")||f.maxInputWidth||(c(this).closest(".tagsinput").width()-f.inputPadding),k="",d=c(this),g=c("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:d.css("fontSize"),fontFamily:d.css("fontFamily"),fontWeight:d.css("fontWeight"),letterSpacing:d.css("letterSpacing"),whiteSpace:"nowrap"}),h=c(this).attr("id")+"_autosize_tester";if(!c("#"+h).length>0){g.attr("id",h);g.appendTo("body")}d.data("minwidth",e);d.data("maxwidth",j);d.data("tester_id",h);d.css("width",e)};c.fn.addTag=function(e,d){d=jQuery.extend({focus:false,callback:true,css_class:"tag"},d);this.each(function(){var l=c(this).attr("id");var j=c(this).val().split(b[l]);if(j[0]==""){j=new Array()}e=jQuery.trim(e);if(d.unique){var g=c(this).tagExist(e);if(g==true){c("#"+l+"_tag").addClass("not_valid")}}else{var g=false}if(e!=""&&g!=true){c("<span>").addClass(d.css_class).append(c("<span>").text(e).append("&nbsp;&nbsp;"),c("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return c("#"+l).removeTag(escape(e))})).insertBefore("#"+l+"_addTag");j.push(e);c("#"+l+"_tag").val("");if(d.focus){c("#"+l+"_tag").focus()}else{c("#"+l+"_tag").blur()}c.fn.tagsInput.updateTagsField(this,j);if(d.callback&&a[l]&&a[l]["onAddTag"]){var k=a[l]["onAddTag"];k.call(this,e)}if(a[l]&&a[l]["onChange"]){var h=j.length;var k=a[l]["onChange"];k.call(this,c(this),j[h-1])}}});return false};c.fn.removeTag=function(d){d=unescape(d);this.each(function(){var h=c(this).attr("id");var e=c(this).val().split(b[h]);c("#"+h+"_tagsinput .tag").remove();str="";for(i=0;i<e.length;i++){if(e[i]!=d){str=str+b[h]+e[i]}}c.fn.tagsInput.importTags(this,str);if(a[h]&&a[h]["onRemoveTag"]){var g=a[h]["onRemoveTag"];g.call(this,d)}});return false};c.fn.tagExist=function(e){var f=c(this).attr("id");var d=c(this).val().split(b[f]);return(jQuery.inArray(e,d)>=0)};c.fn.importTags=function(d){id=c(this).attr("id");c("#"+id+"_tagsinput .tag").remove();c.fn.tagsInput.importTags(this,d)};c.fn.tagsInput=function(d){var e=jQuery.extend({interactive:true,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:false},hide:true,delimiter:",",unique:true,removeWithBackspace:true,placeholderColor:"#666666",autosize:true,comfortZone:20,inputPadding:6*2},d);this.each(function(){if(e.hide){c(this).hide()}var h=c(this).attr("id");if(!h||b[c(this).attr("id")]){h=c(this).attr("id","tags"+new Date().getTime()).attr("id")}var g=jQuery.extend({pid:h,real_input:"#"+h,holder:"#"+h+"_tagsinput",input_wrapper:"#"+h+"_addTag",fake_input:"#"+h+"_tag"},e);b[h]=g.delimiter;if(e.onAddTag||e.onRemoveTag||e.onChange){a[h]=new Array();a[h]["onAddTag"]=e.onAddTag;a[h]["onRemoveTag"]=e.onRemoveTag;a[h]["onChange"]=e.onChange}var f='<div id="'+h+'_tagsinput" class="tagsinput"><div id="'+h+'_addTag">';if(e.interactive){f=f+'<input id="'+h+'_tag" value="" data-default="'+e.defaultText+'" />'}f=f+'</div><div class="tags_clear"></div></div>';c(f).insertAfter(this);c(g.holder).css("width",e.width);c(g.holder).css("min-height",e.height);c(g.holder).css("height","100%");if(c(g.real_input).val()!=""){c.fn.tagsInput.importTags(c(g.real_input),c(g.real_input).val())}if(e.interactive){c(g.fake_input).val(c(g.fake_input).attr("data-default"));c(g.fake_input).css("color",e.placeholderColor);c(g.fake_input).resetAutosize(e);c(g.holder).bind("click",g,function(j){c(j.data.fake_input).focus()});c(g.fake_input).bind("focus",g,function(j){if(c(j.data.fake_input).val()==c(j.data.fake_input).attr("data-default")){c(j.data.fake_input).val("")}c(j.data.fake_input).css("color","#000000")});if(e.autocomplete_url!=undefined){autocomplete_options={source:e.autocomplete_url};for(attrname in e.autocomplete){autocomplete_options[attrname]=e.autocomplete[attrname]}if(jQuery.Autocompleter!==undefined){c(g.fake_input).autocomplete(e.autocomplete_url,e.autocomplete);c(g.fake_input).bind("result",g,function(j,l,k){if(l){c("#"+h).addTag(l[0]+"",{focus:true,unique:(e.unique)})}})}else{if(jQuery.ui.autocomplete!==undefined){c(g.fake_input).autocomplete(autocomplete_options);c(g.fake_input).bind("autocompleteselect",g,function(j,k){c(j.data.real_input).addTag(k.item.value,{focus:true,unique:(e.unique)});return false})}}}else{c(g.fake_input).bind("blur",g,function(j){var k=c(this).attr("data-default");if(c(j.data.fake_input).val()!=""&&c(j.data.fake_input).val()!=k){if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}}else{c(j.data.fake_input).val(c(j.data.fake_input).attr("data-default"));c(j.data.fake_input).css("color",e.placeholderColor)}return false})}c(g.fake_input).bind("keypress",g,function(j){if(j.which==j.data.delimiter.charCodeAt(0)||j.which==13){j.preventDefault();if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}c(j.data.fake_input).resetAutosize(e);return false}else{if(j.data.autosize){c(j.data.fake_input).doAutosize(e)}}});g.removeWithBackspace&&c(g.fake_input).bind("keydown",function(k){if(k.keyCode==8&&c(this).val()==""){k.preventDefault();var j=c(this).closest(".tagsinput").find(".tag:last").text();var l=c(this).attr("id").replace(/_tag$/,"");j=j.replace(/[\s]+x$/,"");c("#"+l).removeTag(escape(j));c(this).trigger("focus")}});c(g.fake_input).blur();if(g.unique){c(g.fake_input).keydown(function(j){if(j.keyCode==8||String.fromCharCode(j.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){c(this).removeClass("not_valid")}})}}});return this};c.fn.tagsInput.updateTagsField=function(e,d){var f=c(e).attr("id");c(e).val(d.join(b[f]))};c.fn.tagsInput.importTags=function(g,h){c(g).val("");var j=c(g).attr("id");var d=h.split(b[j]);for(i=0;i<d.length;i++){c(g).addTag(d[i],{focus:false,callback:false})}if(a[j]&&a[j]["onChange"]){var e=a[j]["onChange"];e.call(g,g,d[i])}}})(jQuery);
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var n={};n.name="mustache.js";n.version="0.7.2";n.tags=["{{","}}"];n.Scanner=s;n.Context=u;n.Writer=v;var d=/\s*/;var a=/\s+/;var b=/\S/;var g=/\s*=/;var o=/\s*\}/;var r=/#|\^|\/|>|\{|&|=|!/;var j=RegExp.prototype.test;var q=Object.prototype.toString;function w(z,y){return j.call(z,y)}function e(y){return !w(b,y)}var l=Array.isArray||function(y){return q.call(y)==="[object Array]"};function f(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function x(y){return String(y).replace(/[&<>"'\/]/g,function(z){return h[z]})}n.escape=x;function s(y){this.string=y;this.tail=y;this.pos=0}s.prototype.eos=function(){return this.tail===""};s.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};s.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function u(y,z){this.view=y;this.parent=z;this._cache={}}u.make=function(y){return(y instanceof u)?y:new u(y)};u.prototype.push=function(y){return new u(y,this)};u.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function v(){this.clearCache()}v.prototype.clearCache=function(){this._cache={};this._partialCache={}};v.prototype.compile=function(y,z){var A=this._cache[y];if(!A){var B=n.parse(y,z);A=this._cache[y]=this.compileTokens(B,y)}return A};v.prototype.compilePartial=function(A,y,z){var B=this.compile(y,z);this._partialCache[A]=B;return B};v.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};v.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return p(A,y,u.make(B),z)}};v.prototype.render=function(z,y,A){return this.compile(z)(y,A)};function p(y,E,z,I){var B="";var A,G,H;for(var D=0,F=y.length;D<F;++D){A=y[D];G=A[1];switch(A[0]){case"#":H=z.lookup(G);if(typeof H==="object"){if(l(H)){for(var C=0,K=H.length;C<K;++C){B+=p(A[4],E,z.push(H[C]),I)}}else{if(H){B+=p(A[4],E,z.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(z.view,J,function(M){return E.render(M,z)});if(H!=null){B+=H}}else{if(H){B+=p(A[4],E,z,I)}}}break;case"^":H=z.lookup(G);if(!H||(l(H)&&H.length===0)){B+=p(A[4],E,z,I)}break;case">":H=E.getPartial(G);if(typeof H==="function"){B+=H(z)}break;case"&":H=z.lookup(G);if(H!=null){B+=H}break;case"name":H=z.lookup(G);if(H!=null){B+=n.escape(H)}break;case"text":B+=G;break}}return B}function m(F){var z=[];var D=z;var E=[];var B;for(var A=0,y=F.length;A<y;++A){B=F[A];switch(B[0]){case"#":case"^":E.push(B);D.push(B);D=B[4]=[];break;case"/":var C=E.pop();C[5]=B[2];D=E.length>0?E[E.length-1][4]:z;break;default:D.push(B)}}return z}function k(D){var C=[];var B,z;for(var A=0,y=D.length;A<y;++A){B=D[A];if(B){if(B[0]==="text"&&z&&z[0]==="text"){z[1]+=B[1];z[3]=B[3]}else{z=B;C.push(B)}}}return C}function t(y){return[new RegExp(f(y[0])+"\\s*"),new RegExp("\\s*"+f(y[1]))]}n.parse=function(G,F){G=G||"";F=F||n.tags;if(typeof F==="string"){F=F.split(a)}if(F.length!==2){throw new Error("Invalid tags: "+F.join(", "))}var O=t(F);var C=new s(G);var H=[];var Q=[];var z=[];var E=false;var P=false;function J(){if(E&&!P){while(z.length){delete Q[z.pop()]}}else{z=[]}E=false;P=false}var B,A,I,K,D;while(!C.eos()){B=C.pos;I=C.scanUntil(O[0]);if(I){for(var M=0,N=I.length;M<N;++M){K=I.charAt(M);if(e(K)){z.push(Q.length)}else{P=true}Q.push(["text",K,B,B+1]);B+=1;if(K=="\n"){J()}}}if(!C.scan(O[0])){break}E=true;A=C.scan(r)||"name";C.scan(d);if(A==="="){I=C.scanUntil(g);C.scan(g);C.scanUntil(O[1])}else{if(A==="{"){I=C.scanUntil(new RegExp("\\s*"+f("}"+F[1])));C.scan(o);C.scanUntil(O[1]);A="&"}else{I=C.scanUntil(O[1])}}if(!C.scan(O[1])){throw new Error("Unclosed tag at "+C.pos)}D=[A,I,B,C.pos];Q.push(D);if(A==="#"||A==="^"){H.push(D)}else{if(A==="/"){if(H.length===0){throw new Error('Unopened section "'+I+'" at '+B)}var y=H.pop();if(y[1]!==I){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(A==="name"||A==="{"||A==="&"){P=true}else{if(A==="="){F=I.split(a);if(F.length!==2){throw new Error("Invalid tags at "+B+": "+F.join(", "))}O=t(F)}}}}}var y=H.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+C.pos)}Q=k(Q);return m(Q)};var c=new v();n.clearCache=function(){return c.clearCache()};n.compile=function(y,z){return c.compile(y,z)};n.compilePartial=function(A,y,z){return c.compilePartial(A,y,z)};n.compileTokens=function(z,y){return c.compileTokens(z,y)};n.render=function(z,y,A){return c.render(z,y,A)};n.to_html=function(z,y,A,C){var B=n.render(z,y,A);if(typeof C==="function"){C(B)}else{return B}};return n}())));(function(a){a.sm={};a.viewmodel={};a.view={};a.templates={};a.extend(a.viewmodel,{version:null});a.extend(a.view,{$document:null});a.sm.loader={};a.extend(a.sm.loader,{templates:["osmPopupTemplate","stopPopupTemplate","stopPopupInfoTemplate"],init:function(){try{this.setDomOptions();this.compileTemplates();a.sm.common.init();a.sm.map.init();a.sm.searcher.init();a.sm.editor.init();a.sm.osm.init();a.sm.user.init();a.sm.stops.init()}catch(b){alert(b)}},bindEvents:function(){},showErrorPopup:function(){},setPopups:function(){},setDomOptions:function(){a.view.$document=a(document)},compileTemplates:function(){var g=this,c=[],f=[],d=[],b,e=this.templates.length;for(b=0;b<e;b++){c.push(a.get(document.url_root+"static/js/templates/"+this.templates[b]+".htm",function(k,j,h){d.push({name:this.url.substr((this.url.lastIndexOf("/")+1)).replace(".htm",""),html:h.responseText})}))}a.when.apply(null,c).done(function(){for(b=0;b<e;b++){var h=d[b].name;a.templates[h]=Mustache.compile(d[b].html)}})}});a(document).ready(function(){a.sm.loader.init()})})(jQuery);(function(a){a.sm.helpers={};a.extend(a.sm.helpers,{getIcon:function(b,c){return L.divIcon({className:b,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})},hashToArrayKeyValues:function(c){var b=[];if(Object.prototype.toString.call(c)==="[object Array]"){return c}for(var d in c){if(!c.hasOwnProperty(d)){continue}b.push({key:d,val:c[d]})}return b},boolToString:function(c,b){switch(c){case null:return b?"null":"";break;case true:return b?"true":"Да";break;case false:return b?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(b){if(b===null){return""}return b},valueCheckToString:function(b){switch(b){case 0:return"Не нужна";break;case 1:return"Нужна";break;case 2:return"Проверена";break}},sortByFields:function(){var c=arguments,b=this;return function(h,g){var d=0,f=0,e=c.length;while(f===0&&d<e){f=b.dynamicSort(c[d])(h,g);d++}return f}},dynamicSort:function(b){var c=1;if(b[0]==="-"){c=-1;b=b.substr(1,b.length-1)}return function(e,d){var f=(e[b]<d[b])?-1:(e[b]>d[b])?1:0;return f*c}}})})(jQuery);(function(a){a.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});a.extend(a.view,{$body:null});a.sm.common={};a.extend(a.sm.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){},showErrorPopup:function(){},setPopups:function(){},setDomOptions:function(){a.view.$body=a("body")}})})(jQuery);(function(a){a.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});a.extend(a.view,{});a.sm.map={};a.extend(a.sm.map,{init:function(){this.setDomOptions();this.buildMap();this.bindEvents()},bindEvents:function(){a.viewmodel.map.on("moveend",function(b){a.view.$document.trigger("/sm/map/updateAllLayers")});a.view.$document.on("/sm/map/updateAllLayers",function(){a.view.$document.trigger("/sm/osm/updateOsmLayer");a.view.$document.trigger("/sm/stops/updateStops")});a.view.$document.on("/sm/map/openPopup",function(h,g,c){var d=a.viewmodel,b=d.mapLayers.select,f=d.map;f.panTo(g);f.openPopup(L.popup().setLatLng(g).setContent(c))});a.view.$document.on("/sm/map/MarkerClick",function(b){});a.viewmodel.map.on("popupclose",function(){var b=a.viewmodel;b.isPopupOpened=false;b.mapLayers.select.clearLayers()})},setDomOptions:function(){},getBbox:function(){return this.map.getBounds()},buildMap:function(){var d=this,f="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",c="Map data © OpenStreetMap contributors",e=new L.TileLayer(f,{minZoom:8,maxZoom:18,attribution:c}),b=L.layerGroup();a.viewmodel.map=new L.Map("map");a.viewmodel.map.setView(new L.LatLng(55.742,37.658),15);a.viewmodel.map.addLayer(e);a.viewmodel.mapLayers.osm=e;a.viewmodel.get_bbox=d.getBbox;a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.select=b}})})(jQuery);(function(a){a.extend(a.sm.map,{getIcon:function(b,c){return L.divIcon({className:b,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})}})})(jQuery);(function(a){a.extend(a.viewmodel,{searcherCollapsed:false});a.extend(a.view,{$searchContainer:null});a.sm.searcher={};a.extend(a.sm.searcher,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var b=this;a.view.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",b.searcherCollapsed)})},setDomOptions:function(){a.view.$searchContainer=a("#searchContainer")},search:function(b,c){}})})(jQuery);(function(a){a.extend(a.viewmodel,{editorCollapsed:false,editable:false,routeTypeSelected:null});a.extend(a.view,{$editorContainer:null});a.sm.editor={};a.extend(a.sm.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},init:function(){this.setDomOptions();this.buildTags();this.buildEditLayer();this.buildRoutesSelector();this.bindEvents()},bindEvents:function(){var b=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.editorCollapsed=!a.viewmodel.editorCollapsed;a.view.$body.toggleClass("editor-collapsed",b.editorCollapsed)});a("#pan_link").off("input").on("input",function(d){var c=document.getElementById("pan_link_a");if(b.regex.url.test(d.target.value)){c.className="active";c.href=d.target.value}else{c.className="";c.href=""}});a.view.$document.on("/sm/editor/startEdit",function(c){b.startAjaxEdition()});a("#save").off("click").on("click",function(c){c.stopPropagation();b.save()});a("#discard").off("click").on("click",function(c){c.stopPropagation();b.finishAjaxEdition()});a("#route_type").off("change").on("change",function(d){var c=d.target.value;a("#route_type_"+a.viewmodel.routeTypeSelected).hide();a("#route_type_"+c).show();a.viewmodel.routeTypeSelected=c});a("#add-route").off("click").on("click",function(c){var d=a("#route_type_"+a.viewmodel.routeTypeSelected).find(":selected");b.addRoute(d.val(),d.text())});a("#editorForm").find(":checkbox").off("click").on("click",function(){var d=a(this),c=a("#"+d.data("id"));if(d.is(":checked")){c.val(1)}else{c.val(0)}})},setDomOptions:function(){a.view.$editorContainer=a("#editorContainer")},buildTags:function(){var b=this;a("#routes").tagsInput({defaultText:"+",width:"185px",maxChars:5,interactive:false,onRemoveTag:function(c){b.removeRoute(c)}})},buildEditLayer:function(){var b=L.layerGroup();a.viewmodel.mapLayers.edit=a.viewmodel.map.addLayer(b)},buildRoutesSelector:function(){var b=a("#route_type").find(":selected").val();a("#route_type_"+b).show();a.viewmodel.routeTypeSelected=b},save:function(){var d=this,j=a("#editorContainer form"),e=j.serializeArray(),f=0,g=e.length,k=a.viewmodel.stopSelected,c=document.url_root+"stop/"+k.id,h={id:k.id},b;for(f;f<g;f+=1){b=e[f].name;switch(b){case b==="lon":h.geom["lon"]=e[f].value;break;case b==="lat":h.geom["lat"]=e[f].value;break;default:h[e[f].name]=e[f].value;break}}h.routes=this.getRoutesToSave(k);a.ajax({type:"POST",url:c,data:{stop:JSON.stringify(h)}}).done(function(){d.finishAjaxEdition()})},getRoutesToSave:function(e){var f=e.routes.routes,c=f.length,b=e.id,d=0,g=[];for(d;d<c;d+=1){g.push({stop_id:b,route_id:f[d].id})}return g},startAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/block/"+a.viewmodel.stopSelected.id}).done(function(){b.startEdit()})},startEdit:function(){var d=a.sm.helpers.getIcon("stop-editable",25),c=a.viewmodel,b=a.view,e;b.$body.addClass("editable");b.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");b.$editorContainer.find("form").removeClass("disabled");c.editable=true;e=L.marker([c.stopSelected.geom.lat,c.stopSelected.geom.lon],{icon:d,draggable:true});e.on("dragend",function(g){var f=g.target.getLatLng();a("#lat").val(f.lat);a("#lon").val(f.lng)});c.mapLayers.edit.addLayer(e);this.fillEditor(c.stopSelected);c.map.closePopup()},fillEditor:function(d){var e=a.sm.helpers;a("#name").val(d.name);a("#id").val(d.id).attr("disabled","disabled");a("#lat").val(d.geom.lat);a("#lon").val(d.geom.lon);this.fillRoutes(d.routes);for(var c=0,b=d.types.length;c<b;c+=1){a("#stype_"+d.types[c].id).prop("checked",true)}a("#is_shelter").val(e.boolToString(d.is_shelter,true));a("#is_bench").val(e.boolToString(d.is_bench,true));a("#pan_link").val(e.valueNullToString(d.panorama_link));a("#comment").val(e.valueNullToString(d.comment));a("#is_check").val(d.is_check)},fillRoutes:function(f){var e=a.sm.helpers,b=f.sort(e.sortByFields("route_type_id","name")),d=0,c=b.length,g={ids:{},routes:b};for(d;d<c;d+=1){g.ids[b[d].id]=true;a("#routes").addTag(b[d].name,{css_class:"tag type-id-"+b[d].route_type_id})}a.viewmodel.stopSelected.routes=g},addRoute:function(f,b){var c=a.viewmodel,e=c.routeTypeSelected,d=c.stopSelected.routes;if(d.ids[f]){return false}else{d.ids[f]=true}d.routes.push({route_type_id:e,id:f,name:b});this.updateUIRoutes(d.routes)},removeRoute:function(b){var e=a.viewmodel,g=e.stopSelected.routes,f,d=0,c=g.routes.length;for(d;d<c;d+=1){if(g.routes[d].name===b){f=g.routes[d];g.ids[f.id]=false;g.routes.splice(d,1);break}}this.updateUIRoutes(g.routes)},updateUIRoutes:function(d){var c=0,b=d.length;d=d.sort(a.sm.helpers.sortByFields("route_type_id","name"));this.clearUIRoutes();for(c;c<b;c+=1){a("#routes").addTag(d[c].name,{css_class:"tag type-id-"+d[c].route_type_id})}},clearUIRoutes:function(){a("#routes").importTags("")},finishAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/unblock/"+a.viewmodel.stopSelected.id}).done(function(){b.finishEditing()})},finishEditing:function(){var c=a.view.$document,d=a.viewmodel,b=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;b.$body.addClass("editable");b.$editorContainer.find("input, textarea").val("");b.$editorContainer.find("input:checkbox").prop("checked",false);b.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled");b.$editorContainer.find("form").addClass("disabled");a("#routes").importTags("");a.view.$document.trigger("/sm/map/updateAllLayers")}})})(jQuery);(function(a){a.extend(a.viewmodel,{osmStops:{}});a.extend(a.view,{});a.sm.osm={};a.extend(a.sm.osm,{osmMaxClusterRadius:80,init:function(){this.setDomOptions();this.buildOsmStopsLayer();this.updateStopsFromXapi();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/osm/updateOsmLayer",function(){b.updateOsmLayer()});a.viewmodel.map.on("zoomend",function(c){a.view.$document.trigger("/sm/osm/updateOsmLayer")})},setDomOptions:function(){},buildOsmStopsLayer:function(){var b=new L.layerGroup();a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.osmStops=b},updateOsmLayer:function(){var b=this.validateZoom();a.viewmodel.mapLayers.osmStops.clearLayers();if(!b){return}this.updateStopsFromXapi()},offOsmLayer:function(){a.viewmodel.mapLayers.osmStops.clearLayers()},onOsmLayer:function(){this.updateOsmLayer(false)},renderStops:function(b){var h=b.elements,e=a.viewmodel,j=e.mapLayers.osmStops,d=a.sm.map.getIcon("osm-bus-stop",16),g;e.osmStops={};popupHtml=a.templates.stopPopupTemplate({css:"block"});for(var c=0,f=h.length;c<f;c++){e.osmStops[h[c].id]=h[c];g=L.marker([h[c].lat,h[c].lon],{icon:d}).on("click",function(n){a.view.$document.trigger("/sm/map/MarkerClick");var m=n.target,l=a.viewmodel.osmStops[m.id_osm],k=a.templates.osmPopupTemplate({tags:a.sm.helpers.hashToArrayKeyValues(l.tags),id:l.id,link:"http://www.openstreetmap.org/browse/node/"+l.id});a.view.$document.trigger("/sm/map/openPopup",[m.getLatLng(),k])});g.id_osm=h[c].id;j.addLayer(g)}},updateStopsFromXapi:function(){var c=this,b=c.getApiUrl(a.viewmodel.map.getBounds());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},getApiUrl:function(c){var b=c.getSouthWest(),e=c.getNorthEast(),d="http://overpass-api.de/api/interpreter?data=[out:json];(node[highway=bus_stop]("+b.lat+","+b.lng+","+e.lat+","+e.lng+");>;);out;";return d},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{stopSelected:null,stopSelectedId:null});a.extend(a.view,{});a.sm.stops={};a.extend(a.sm.stops,{init:function(){this.setDomOptions();this.buildStopsLayers();this.updateStops();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/stops/updateStops",function(d,c){b.updateStops(c)});a.view.$document.off("/sm/map/openPopupEnd").on("/sm/map/openPopupEnd",function(c){})},setDomOptions:function(){},buildStopsLayers:function(){var c=new L.layerGroup(),b=new L.layerGroup();a.viewmodel.map.addLayer(c);a.viewmodel.mapLayers.stops=c;a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.edit=b},updateStops:function(){var b=this.validateZoom();a.viewmodel.mapLayers.stops.clearLayers();if(!b){return}this.updateStopsByAjax()},updateStopsByAjax:function(){var c=this,b=document.url_root+"stops?bbox="+JSON.stringify(a.viewmodel.get_bbox());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},renderStops:function(j){var e=a.sm.map,d=a.viewmodel,o=d.mapLayers.stops,n=e.getIcon("stop-block",20),f=e.getIcon("stop-edit",20),c=e.getIcon("stop-check",20),l,m,g,k,h=a.templates.stopPopupTemplate({css:"edit"}),b=this;l=j.stops.block;for(m in l){if(l.hasOwnProperty(m)){g=L.marker([l[m].lat,l[m].lon],{icon:n}).on("click",function(q){var p=q.target;a.view.$document.trigger("/sm/map/openPopup",[p.getLatLng(),h]);b.buildStopPopup(p.stop_id)});g.stop_id=m;o.addLayer(g)}}l=j.stops.non_block.non_check;for(m in l){if(l.hasOwnProperty(m)){g=L.marker([l[m].lat,l[m].lon],{icon:f}).on("click",function(q){var p=q.target;a.view.$document.trigger("/sm/map/openPopup",[p.getLatLng(),h]);b.buildStopPopup(p.stop_id)});g.stop_id=m;o.addLayer(g)}}l=j.stops.non_block.check;for(m in l){if(l.hasOwnProperty(m)){g=L.marker([l[m].lat,l[m].lon],{icon:f}).on("click",function(q){var p=q.target;a.view.$document.trigger("/sm/map/openPopup",[p.getLatLng(),h]);b.buildStopPopup(p.stop_id)});g.stop_id=m;o.addLayer(g)}}},buildStopPopup:function(b){return a.getJSON(document.url_root+"stop/"+b,function(e){a.viewmodel.stopSelected=e.stop;var c=a.sm.helpers,d=a.templates.stopPopupInfoTemplate({id:e.stop.id,name:e.stop.name,is_shelter:c.boolToString(e.stop.is_shelter),is_bench:c.boolToString(e.stop.is_bench),stop_type_id:c.valueNullToString(e.stop.stop_type_id),routes:e.stop.routes,types:e.stop.types,check_status:c.valueCheckToString(e.stop.check_status),comment:c.valueNullToString(e.stop.comment),isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable||e.stop.is_block,isBlock:e.stop.is_block,userBlock:e.stop.user_block});a("#stop-popup").removeClass("loader").empty().append(d);a("button#edit").off("click").on("click",function(f){a.view.$document.trigger("/sm/editor/startEdit")})}).error(function(){a("#stop-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{isAuth:false});a.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.sm.user={};a.extend(a.sm.user,{init:function(){this.setDomOptions()},setDomOptions:function(){a.view.$userContainer=a("#userContainer");a.view.$signInForm=a("#signInForm");a.view.$signOutForm=a("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}}})})(jQuery);