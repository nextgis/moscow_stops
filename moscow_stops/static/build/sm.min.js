(function(c){var a=new Array();var b=new Array();c.fn.doAutosize=function(h){var f=c(this).data("minwidth"),p=c(this).data("maxwidth"),k="",n=c(this),j=c("#"+c(this).data("tester_id"));if(k===(k=n.val())){return}var e=k.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");j.html(e);var m=j.width(),l=(m+h.comfortZone)>=f?m+h.comfortZone:f,g=n.width(),d=(l<g&&l>=f)||(l>f&&l<p);if(d){n.width(l)}};c.fn.resetAutosize=function(f){var h=c(this).data("minwidth")||f.minInputWidth||c(this).width(),j=c(this).data("maxwidth")||f.maxInputWidth||(c(this).closest(".tagsinput").width()-f.inputPadding),k="",e=c(this),g=c("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),d=c(this).attr("id")+"_autosize_tester";if(!c("#"+d).length>0){g.attr("id",d);g.appendTo("body")}e.data("minwidth",h);e.data("maxwidth",j);e.data("tester_id",d);e.css("width",h)};c.fn.addTag=function(e,d){d=jQuery.extend({focus:false,callback:true,css_class:"tag"},d);this.each(function(){var l=c(this).attr("id");var g=c(this).val().split(a[l]);if(g[0]==""){g=new Array()}e=jQuery.trim(e);if(d.unique){var h=c(this).tagExist(e);if(h==true){c("#"+l+"_tag").addClass("not_valid")}}else{var h=false}if(e!=""&&h!=true){c("<span>").addClass(d.css_class).append(c("<span>").text(e).append("&nbsp;&nbsp;"),c("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return c("#"+l).removeTag(escape(e))})).insertBefore("#"+l+"_addTag");g.push(e);c("#"+l+"_tag").val("");if(d.focus){c("#"+l+"_tag").focus()}else{c("#"+l+"_tag").blur()}c.fn.tagsInput.updateTagsField(this,g);if(d.callback&&b[l]&&b[l]["onAddTag"]){var k=b[l]["onAddTag"];k.call(this,e)}if(b[l]&&b[l]["onChange"]){var j=g.length;var k=b[l]["onChange"];k.call(this,c(this),g[j-1])}}});return false};c.fn.removeTag=function(d){d=unescape(d);this.each(function(){var h=c(this).attr("id");var e=c(this).val().split(a[h]);c("#"+h+"_tagsinput .tag").remove();str="";for(i=0;i<e.length;i++){if(e[i]!=d){str=str+a[h]+e[i]}}c.fn.tagsInput.importTags(this,str);if(b[h]&&b[h]["onRemoveTag"]){var g=b[h]["onRemoveTag"];g.call(this,d)}});return false};c.fn.tagExist=function(e){var f=c(this).attr("id");var d=c(this).val().split(a[f]);return(jQuery.inArray(e,d)>=0)};c.fn.importTags=function(d){id=c(this).attr("id");c("#"+id+"_tagsinput .tag").remove();c.fn.tagsInput.importTags(this,d)};c.fn.tagsInput=function(d){var e=jQuery.extend({interactive:true,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:false},hide:true,delimiter:",",unique:true,removeWithBackspace:true,placeholderColor:"#666666",autosize:true,comfortZone:20,inputPadding:6*2},d);this.each(function(){if(e.hide){c(this).hide()}var h=c(this).attr("id");if(!h||a[c(this).attr("id")]){h=c(this).attr("id","tags"+new Date().getTime()).attr("id")}var g=jQuery.extend({pid:h,real_input:"#"+h,holder:"#"+h+"_tagsinput",input_wrapper:"#"+h+"_addTag",fake_input:"#"+h+"_tag"},e);a[h]=g.delimiter;if(e.onAddTag||e.onRemoveTag||e.onChange){b[h]=new Array();b[h]["onAddTag"]=e.onAddTag;b[h]["onRemoveTag"]=e.onRemoveTag;b[h]["onChange"]=e.onChange}var f='<div id="'+h+'_tagsinput" class="tagsinput"><div id="'+h+'_addTag">';if(e.interactive){f=f+'<input id="'+h+'_tag" value="" data-default="'+e.defaultText+'" />'}f=f+'</div><div class="tags_clear"></div></div>';c(f).insertAfter(this);c(g.holder).css("width",e.width);c(g.holder).css("min-height",e.height);c(g.holder).css("height","100%");if(c(g.real_input).val()!=""){c.fn.tagsInput.importTags(c(g.real_input),c(g.real_input).val())}if(e.interactive){c(g.fake_input).val(c(g.fake_input).attr("data-default"));c(g.fake_input).css("color",e.placeholderColor);c(g.fake_input).resetAutosize(e);c(g.holder).bind("click",g,function(j){c(j.data.fake_input).focus()});c(g.fake_input).bind("focus",g,function(j){if(c(j.data.fake_input).val()==c(j.data.fake_input).attr("data-default")){c(j.data.fake_input).val("")}c(j.data.fake_input).css("color","#000000")});if(e.autocomplete_url!=undefined){autocomplete_options={source:e.autocomplete_url};for(attrname in e.autocomplete){autocomplete_options[attrname]=e.autocomplete[attrname]}if(jQuery.Autocompleter!==undefined){c(g.fake_input).autocomplete(e.autocomplete_url,e.autocomplete);c(g.fake_input).bind("result",g,function(j,l,k){if(l){c("#"+h).addTag(l[0]+"",{focus:true,unique:(e.unique)})}})}else{if(jQuery.ui.autocomplete!==undefined){c(g.fake_input).autocomplete(autocomplete_options);c(g.fake_input).bind("autocompleteselect",g,function(j,k){c(j.data.real_input).addTag(k.item.value,{focus:true,unique:(e.unique)});return false})}}}else{c(g.fake_input).bind("blur",g,function(j){var k=c(this).attr("data-default");if(c(j.data.fake_input).val()!=""&&c(j.data.fake_input).val()!=k){if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}}else{c(j.data.fake_input).val(c(j.data.fake_input).attr("data-default"));c(j.data.fake_input).css("color",e.placeholderColor)}return false})}c(g.fake_input).bind("keypress",g,function(j){if(j.which==j.data.delimiter.charCodeAt(0)||j.which==13){j.preventDefault();if((j.data.minChars<=c(j.data.fake_input).val().length)&&(!j.data.maxChars||(j.data.maxChars>=c(j.data.fake_input).val().length))){c(j.data.real_input).addTag(c(j.data.fake_input).val(),{focus:true,unique:(e.unique)})}c(j.data.fake_input).resetAutosize(e);return false}else{if(j.data.autosize){c(j.data.fake_input).doAutosize(e)}}});g.removeWithBackspace&&c(g.fake_input).bind("keydown",function(k){if(k.keyCode==8&&c(this).val()==""){k.preventDefault();var j=c(this).closest(".tagsinput").find(".tag:last").text();var l=c(this).attr("id").replace(/_tag$/,"");j=j.replace(/[\s]+x$/,"");c("#"+l).removeTag(escape(j));c(this).trigger("focus")}});c(g.fake_input).blur();if(g.unique){c(g.fake_input).keydown(function(j){if(j.keyCode==8||String.fromCharCode(j.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){c(this).removeClass("not_valid")}})}}});return this};c.fn.tagsInput.updateTagsField=function(e,d){var f=c(e).attr("id");c(e).val(d.join(a[f]))};c.fn.tagsInput.importTags=function(g,h){c(g).val("");var j=c(g).attr("id");var d=h.split(a[j]);for(i=0;i<d.length;i++){c(g).addTag(d[i],{focus:false,callback:false})}if(b[j]&&b[j]["onChange"]){var e=b[j]["onChange"];e.call(g,g,d[i])}}})(jQuery);
/*
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(m){var j=this,o=a.isFunction(a.Deferred)?a.Deferred():0,n=a.isFunction(o.notify),f=j.find("img").add(j.filter("img")),g=[],l=[],h=[];if(a.isPlainObject(m)){a.each(m,function(p,q){if(p==="callback"){m=q}else{if(o){o[p](q)}}})}function k(){var p=a(l),q=a(h);if(o){if(h.length){o.reject(f,p,q)}else{o.resolve(f)}}if(a.isFunction(m)){m.call(j,f,p,q)}}function e(p){d(p.target,p.type==="error")}function d(p,q){if(p.src===c||a.inArray(p,g)!==-1){return}g.push(p);if(q){h.push(p)}else{l.push(p)}a.data(p,"imagesLoaded",{isBroken:q,src:p.src});if(n){o.notifyWith(a(p),[q,f,a(l),a(h)])}if(f.length===g.length){setTimeout(k);f.unbind(".imagesLoaded",e)}}if(!f.length){k()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(p,r){var s=r.src;var q=a.data(r,"imagesLoaded");if(q&&q.src===s){d(r,q.isBroken);return}if(r.complete&&r.naturalWidth!==b){d(r,r.naturalWidth===0||r.naturalHeight===0);return}if(r.readyState||r.complete){r.src=c;r.src=s}})}return o?o.promise(j):j}})(jQuery);L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(b,a){L.Util.setOptions(this,a);this._key=b;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(a,g,e){var c="";for(var d=e;d>0;d--){var f=0;var b=1<<(d-1);if((a&b)!=0){f+=1}if((g&b)!=0){f+=2}c=c+f}return c},getTileUrl:function(c,d){var d=this._getZoomForUrl();var a=this.options.subdomains,b=this.options.subdomains[Math.abs((c.x+c.y)%a.length)];return this._url.replace("{subdomain}",b).replace("{quadkey}",this.tile2quad(c.x,c.y,d)).replace("{culture}",this.options.culture)},loadMetadata:function(){var d=this;var c="_bing_metadata_"+L.Util.stamp(this);window[c]=function(g){d.meta=g;window[c]=undefined;var f=document.getElementById(c);f.parentNode.removeChild(f);if(g.errorDetails){alert("Got metadata"+g.errorDetails);return}d.initMetadata()};var b="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+c+"&key="+this._key;var a=document.createElement("script");a.type="text/javascript";a.src=b;a.id=c;document.getElementsByTagName("head")[0].appendChild(a)},initMetadata:function(){var e=this.meta.resourceSets[0].resources[0];this.options.subdomains=e.imageUrlSubdomains;this._url=e.imageUrl;this._providers=[];for(var b=0;b<e.imageryProviders.length;b++){var g=e.imageryProviders[b];for(var a=0;a<g.coverageAreas.length;a++){var h=g.coverageAreas[a];var f={zoomMin:h.zoomMin,zoomMax:h.zoomMax,active:false};var d=new L.LatLngBounds(new L.LatLng(h.bbox[0]+0.01,h.bbox[1]+0.01),new L.LatLng(h.bbox[2]-0.01,h.bbox[3]-0.01));f.bounds=d;f.attrib=g.attribution;this._providers.push(f)}}this._update()},_update:function(){if(this._url==null||!this._map){return}this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var c=this._map.getBounds();var b=this._map.getZoom();for(var a=0;a<this._providers.length;a++){var d=this._providers[a];if((b<=d.zoomMax&&b>=d.zoomMin)&&c.intersects(d.bounds)){if(!d.active){this._map.attributionControl.addAttribution(d.attrib)}d.active=true}else{if(d.active){this._map.attributionControl.removeAttribution(d.attrib)}d.active=false}}},onRemove:function(c){for(var a=0;a<this._providers.length;a++){var b=this._providers[a];if(b.active){this._map.attributionControl.removeAttribution(b.attrib);b.active=false}}L.TileLayer.prototype.onRemove.apply(this,[c])}});
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var w={};w.name="mustache.js";w.version="0.7.2";w.tags=["{{","}}"];w.Scanner=u;w.Context=s;w.Writer=q;var d=/\s*/;var l=/\s+/;var h=/\S/;var g=/\s*=/;var n=/\s*\}/;var t=/#|\^|\/|>|\{|&|=|!/;var j=RegExp.prototype.test;var v=Object.prototype.toString;function o(z,y){return j.call(z,y)}function f(y){return !o(h,y)}var k=Array.isArray||function(y){return v.call(y)==="[object Array]"};function e(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function m(y){return String(y).replace(/[&<>"'\/]/g,function(z){return c[z]})}w.escape=m;function u(y){this.string=y;this.tail=y;this.pos=0}u.prototype.eos=function(){return this.tail===""};u.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};u.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function s(y,z){this.view=y;this.parent=z;this._cache={}}s.make=function(y){return(y instanceof s)?y:new s(y)};s.prototype.push=function(y){return new s(y,this)};s.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function q(){this.clearCache()}q.prototype.clearCache=function(){this._cache={};this._partialCache={}};q.prototype.compile=function(A,y){var z=this._cache[A];if(!z){var B=w.parse(A,y);z=this._cache[A]=this.compileTokens(B,A)}return z};q.prototype.compilePartial=function(z,B,y){var A=this.compile(B,y);this._partialCache[z]=A;return A};q.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};q.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return p(A,y,s.make(B),z)}};q.prototype.render=function(A,y,z){return this.compile(A)(y,z)};function p(F,z,y,I){var C="";var A,G,H;for(var D=0,E=F.length;D<E;++D){A=F[D];G=A[1];switch(A[0]){case"#":H=y.lookup(G);if(typeof H==="object"){if(k(H)){for(var B=0,K=H.length;B<K;++B){C+=p(A[4],z,y.push(H[B]),I)}}else{if(H){C+=p(A[4],z,y.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(y.view,J,function(M){return z.render(M,y)});if(H!=null){C+=H}}else{if(H){C+=p(A[4],z,y,I)}}}break;case"^":H=y.lookup(G);if(!H||(k(H)&&H.length===0)){C+=p(A[4],z,y,I)}break;case">":H=z.getPartial(G);if(typeof H==="function"){C+=H(y)}break;case"&":H=y.lookup(G);if(H!=null){C+=H}break;case"name":H=y.lookup(G);if(H!=null){C+=w.escape(H)}break;case"text":C+=G;break}}return C}function x(E){var z=[];var D=z;var F=[];var B;for(var A=0,y=E.length;A<y;++A){B=E[A];switch(B[0]){case"#":case"^":F.push(B);D.push(B);D=B[4]=[];break;case"/":var C=F.pop();C[5]=B[2];D=F.length>0?F[F.length-1][4]:z;break;default:D.push(B)}}return z}function a(D){var A=[];var C,z;for(var B=0,y=D.length;B<y;++B){C=D[B];if(C){if(C[0]==="text"&&z&&z[0]==="text"){z[1]+=C[1];z[3]=C[3]}else{z=C;A.push(C)}}}return A}function r(y){return[new RegExp(e(y[0])+"\\s*"),new RegExp("\\s*"+e(y[1]))]}w.parse=function(P,E){P=P||"";E=E||w.tags;if(typeof E==="string"){E=E.split(l)}if(E.length!==2){throw new Error("Invalid tags: "+E.join(", "))}var I=r(E);var A=new u(P);var G=[];var F=[];var D=[];var Q=false;var O=false;function N(){if(Q&&!O){while(D.length){delete F[D.pop()]}}else{D=[]}Q=false;O=false}var B,z,H,J,C;while(!A.eos()){B=A.pos;H=A.scanUntil(I[0]);if(H){for(var K=0,M=H.length;K<M;++K){J=H.charAt(K);if(f(J)){D.push(F.length)}else{O=true}F.push(["text",J,B,B+1]);B+=1;if(J=="\n"){N()}}}if(!A.scan(I[0])){break}Q=true;z=A.scan(t)||"name";A.scan(d);if(z==="="){H=A.scanUntil(g);A.scan(g);A.scanUntil(I[1])}else{if(z==="{"){H=A.scanUntil(new RegExp("\\s*"+e("}"+E[1])));A.scan(n);A.scanUntil(I[1]);z="&"}else{H=A.scanUntil(I[1])}}if(!A.scan(I[1])){throw new Error("Unclosed tag at "+A.pos)}C=[z,H,B,A.pos];F.push(C);if(z==="#"||z==="^"){G.push(C)}else{if(z==="/"){if(G.length===0){throw new Error('Unopened section "'+H+'" at '+B)}var y=G.pop();if(y[1]!==H){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(z==="name"||z==="{"||z==="&"){O=true}else{if(z==="="){E=H.split(l);if(E.length!==2){throw new Error("Invalid tags at "+B+": "+E.join(", "))}I=r(E)}}}}}var y=G.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+A.pos)}F=a(F);return x(F)};var b=new q();w.clearCache=function(){return b.clearCache()};w.compile=function(z,y){return b.compile(z,y)};w.compilePartial=function(z,A,y){return b.compilePartial(z,A,y)};w.compileTokens=function(z,y){return b.compileTokens(z,y)};w.render=function(A,y,z){return b.render(A,y,z)};w.to_html=function(B,z,A,C){var y=w.render(B,z,A);if(typeof C==="function"){C(y)}else{return y}};return w}())));(function(a){a.sm={};a.viewmodel={};a.view={};a.templates={};a.extend(a.viewmodel,{version:null});a.extend(a.view,{$document:null});a.sm.loader={};a.extend(a.sm.loader,{templates:["osmPopupTemplate","stopPopupTemplate","stopPopupInfoTemplate","searchResultsTemplate","userLogsTemplate"],init:function(){this.setDomOptions();this.compileTemplates()},initModules:function(){try{a.sm.common.init();a.sm.map.init();a.sm.searcher.init();a.sm.editor.init();a.sm.osm.init();a.sm.user.init();a.sm.stops.init()}catch(b){alert(b)}},setDomOptions:function(){a.view.$document=a(document)},compileTemplates:function(){var d=this,g=[],c=[],e=[],f,b=this.templates.length;for(f=0;f<b;f++){g.push(a.get(document.url_root+"static/js/templates/"+this.templates[f]+".htm",function(k,j,h){e.push({name:this.url.substr((this.url.lastIndexOf("/")+1)).replace(".htm",""),html:h.responseText})}))}a.when.apply(null,g).done(function(){for(f=0;f<b;f++){var h=e[f].name;a.templates[h]=Mustache.compile(e[f].html)}window.setTimeout(function(){d.initModules();a("img").imagesLoaded(function(){a.view.$body.removeClass("loading")})},1000)})}});a(document).ready(function(){a.sm.loader.init()})})(jQuery);(function(a){a.sm.helpers={};a.extend(a.sm.helpers,{getIcon:function(c,b){return L.divIcon({className:c,iconSize:[b,b],iconAnchor:[b/2,b/2],popupAnchor:[0,2-(b/2)]})},hashToArrayKeyValues:function(c){var b=[];if(Object.prototype.toString.call(c)==="[object Array]"){return c}for(var d in c){if(!c.hasOwnProperty(d)){continue}b.push({key:d,val:c[d]})}return b},boolToString:function(c,b){switch(c){case null:return b?"null":"";break;case true:return b?"true":"Да";break;case false:return b?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(b){if(b===null){return""}return b},valueCheckToString:function(b){switch(b){case 0:return"Не нужна";break;case 1:return"Нужна";break;case 2:return"Проверена";break;case 3:return"Проверена по Бингу";break;default:return"Не нужна";break}},sortByFields:function(){var c=arguments,b=this;return function(h,g){var e=0,d=0,f=c.length;while(d===0&&e<f){d=b.dynamicSort(c[e])(h,g);e++}return d}},dynamicSort:function(c){var b=1;if(c[0]==="-"){b=-1;c=c.substr(1,c.length-1)}return function(f,e){var d=(f[c]<e[c])?-1:(f[c]>e[c])?1:0;return d*b}}})})(jQuery);(function(a){a.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});a.extend(a.view,{$body:null,$popup:null});a.sm.common={};a.extend(a.sm.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/common/openPopup",function(d,f,c){b.openPopup(f,c)});a.view.$popup.find("a.close").off("click").on("click",function(){a.view.$body.removeClass("popup")});a.view.$document.on("/sm/common/setMainLoad",function(){a.view.$body.addClass("loader")})},openPopup:function(f,b){var e=a.view.$popup,d,c;e.find("div.header").text(f);e.find("div.content").html(b);d=e.width()/2;c=e.height()/2;e.css({"margin-left":-d+"px","margin-top":-c+"px"});a.view.$body.addClass("popup")},closePopup:function(){},setDomOptions:function(){a.view.$body=a("body");a.view.$popup=a("#popup")}})})(jQuery);(function(a){a.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});a.extend(a.view,{$map:null});a.sm.map={};a.extend(a.sm.map,{init:function(){this.setDomOptions();this.buildMap();this.buildLayerManager();this.bindEvents()},bindEvents:function(){a.viewmodel.map.on("moveend",function(b){a.view.$document.trigger("/sm/map/updateAllLayers")});a.view.$document.on("/sm/map/updateAllLayers",function(){a.view.$document.trigger("/sm/stops/updateStops");a.view.$document.trigger("/sm/osm/updateOsmLayer")});a.view.$document.on("/sm/map/openPopup",function(g,h,c){var d=a.viewmodel,b=d.mapLayers.select,f=d.map;f.panTo(h);f.openPopup(L.popup().setLatLng(h).setContent(c))});a.viewmodel.map.on("popupclose",function(){var b=a.viewmodel;b.isPopupOpened=false;b.mapLayers.select.clearLayers()})},setDomOptions:function(){},getBbox:function(){return this.map.getBounds()},buildMap:function(){var c=this,d=a.viewmodel,b=L.layerGroup();a.view.$map=a("#map");d.map=new L.Map("map");L.control.scale().addTo(d.map);d.map.setView(new L.LatLng(55.742,37.658),15);d.get_bbox=c.getBbox;d.map.addLayer(b);d.mapLayers.select=b}})})(jQuery);(function(a){a.extend(a.sm.map,{getIcon:function(c,b){return L.divIcon({className:c,iconSize:[b,b],iconAnchor:[b/2,b/2],popupAnchor:[0,2-(b/2)]})}})})(jQuery);(function(a){a.extend(a.viewmodel,{currentTileLayer:null});a.extend(a.view,{$tileLayers:null,$manager:null});a.extend(a.sm.map,{_layers:{},_lastIndex:0,buildLayerManager:function(){var b=a.view;a.view.$manager=a("#manager");this.addTileLayer("osm","http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors");this.addBingLayer("AujH--7B6FRTK8b81QgPhuvw_Sb3kc8hBO-Lp5OLNyhCD4ZQoGGW4cQS6zBgaeEh");a.view.$tileLayers=b.$map.find("div.leaflet-tile-pane div.leaflet-layer");this.bindLayerManagerEvents();this.onLayer("osm")},bindLayerManagerEvents:function(){var b=this;a.viewmodel.map.off("zoomend").on("zoomend",function(){b.onLayer()});a.view.$manager.find("div.tile-layers div.icon").off("click").on("click",function(c){b.onLayer(a(this).data("layer"))})},onLayer:function(d){var c=a.viewmodel,b=a.view,e=a(a.viewmodel.map.getPanes().tilePane).find("div.leaflet-layer");if(d){b.$body.removeClass(c.currentTileLayer).addClass(d);c.currentTileLayer=d;e.hide().eq(this._layers[d].index).show()}else{e.hide().eq(this._layers[c.currentTileLayer].index).show()}},addTileLayer:function(e,c,b){var d=new L.TileLayer(c,{minZoom:8,maxZoom:18,attribution:b});this._layers[e]={layer:a.viewmodel.map.addLayer(d,true),index:this._lastIndex};this._lastIndex=+1},addBingLayer:function(c){var b=new L.BingLayer(c,{minZoom:8,maxZoom:19});this._layers.bing={layer:a.viewmodel.map.addLayer(b,true),index:this._lastIndex};this._lastIndex=+1}})})(jQuery);(function(a){a.extend(a.viewmodel,{searcherCollapsed:false,filter:{id:"",name:"",is_help:""},isFilterValidated:true});a.extend(a.view,{$searchContainer:null,$filterName:null,$filterId:null,$filterIsHelp:null,$searchButton:null,$searchResults:null});a.sm.searcher={};a.extend(a.sm.searcher,{min_characters_name:3,init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this,b=a.view;b.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",c.searcherCollapsed)});b.$filterName.off("keyup").on("keyup",function(d){c.keyUpHandler(d)});b.$filterId.off("keyup").on("keyup",function(d){c.keyUpHandler(d)});a("#filter_name, #filter_id").off("focus").on("focus",function(){a.view.$searchResults.prop("class","description")});a("#searchResults p.description").off("click").on("click",function(){a.view.$searchResults.prop("class","active")});b.$searchButton.off("click").on("click",function(){if(a.viewmodel.isFilterValidated){c.applyFilter()}});b.$document.on("/sm/searcher/update",function(){c.updateSearch()});b.$document.on("/sm/stops/startUpdate",function(){var d=a.view;d.$searchResults.prop("class","update");d.$filterName.prop("disabled",true);d.$filterId.prop("disabled",true)});b.$document.on("/sm/stops/endUpdate",function(){var d=a.view;d.$searchResults.prop("class","active");d.$filterName.prop("disabled",false);d.$filterId.prop("disabled",false)})},setDomOptions:function(){var b=a.view;b.$searchContainer=a("#searchContainer");b.$filterName=a("#filter_name");b.$filterId=a("#filter_id");b.$filterIsHelp=a("#filter_is_help");b.$searchButton=a("#search");b.$searchResults=a("#searchResults")},keyUpHandler:function(b){this.validateSearch();if(b.keyCode==13){this.applyFilter()}},validateSearch:function(){var e=/^\d+$/,f=this.min_characters_name,b=a.view,d=a.viewmodel,g=b.$filterId.val(),c=b.$filterName.val();if(c.length<=f&&c!=""){b.$filterName.addClass("invalid")}else{b.$filterName.removeClass("invalid")}if(!e.test(g)&&g!=""){b.$filterId.addClass("invalid")}else{b.$filterId.removeClass("invalid")}if((c.length>f&&g=="")||((c==""||c.length<=f)&&e.test(g))||(c.length>f&&e.test(g))||(c==""&&g=="")){d.isFilterValidated=true}else{d.isFilterValidated=false}a.view.$searchButton.toggleClass("active",a.viewmodel.isFilterValidated)},applyFilter:function(){if(a.viewmodel.isFilterValidated){this.updateFilter();this.search()}},updateFilter:function(){var c=a.view,b=a.viewmodel;b.filter.name=c.$filterName.val();b.filter.id=c.$filterId.val();b.filter.is_help=c.$filterIsHelp.is(":checked")},search:function(){a.view.$document.trigger("/sm/stops/updateStops")},updateSearch:function(){var d=a.viewmodel.stops,c=a.view.$searchResults.find("div"),b;b=this.getHtmlForSearchResults("non_check",d.non_block.non_check.elements);b+=this.getHtmlForSearchResults("check",d.non_block.check.elements);b+=this.getHtmlForSearchResults("block",d.block.elements);c.empty().append(b);c.find("a").on("click",function(){var e=a(this).parent();a.viewmodel.map.setView(new L.LatLng(e.data("lat"),e.data("lon")),18);a("#target").show().delay(1000).fadeOut(1000)});a.view.$searchResults.prop("class","active")},getHtmlForSearchResults:function(b,c){return a.templates.searchResultsTemplate({cssClass:b,stops:c})}})})(jQuery);(function(a){a.extend(a.viewmodel,{editorCollapsed:false,editable:false,routeTypeSelected:null});a.extend(a.view,{$editorContainer:null});a.sm.editor={};a.extend(a.sm.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},init:function(){this.setDomOptions();this.buildTags();this.buildEditLayer();this.buildRoutesSelector();this.bindEvents()},bindEvents:function(){var b=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.editorCollapsed=!a.viewmodel.editorCollapsed;a.view.$body.toggleClass("editor-collapsed",b.editorCollapsed)});a("#pan_link").off("input").on("input",function(){b.validateLink()});a.view.$document.on("/sm/editor/startEdit",function(c){b.startAjaxEdition()});a("#save").off("click").on("click",function(c){c.stopPropagation();b.save()});a("#discard").off("click").on("click",function(c){c.stopPropagation();b.finishAjaxEdition()});a("#route_type").off("change").on("change",function(d){var c=d.target.value;a("#route_type_"+a.viewmodel.routeTypeSelected).hide();a("#route_type_"+c).show();a.viewmodel.routeTypeSelected=c});a("#add-route").off("click").on("click",function(c){var d=a("#route_type_"+a.viewmodel.routeTypeSelected).find(":selected");b.addRoute(d.val(),d.text())});a("#editorForm").find(":checkbox").off("click").on("click",function(){var d=a(this),c=a("#"+d.data("id"));if(d.is(":checked")){c.val(1)}else{c.val(0)}})},setDomOptions:function(){a.view.$editorContainer=a("#editorContainer")},buildTags:function(){var b=this;a("#routes").tagsInput({defaultText:"+",width:"185px",maxChars:5,interactive:false,onRemoveTag:function(c){b.removeRoute(c)}})},buildEditLayer:function(){var b=L.layerGroup();a.viewmodel.mapLayers.edit=a.viewmodel.map.addLayer(b)},buildRoutesSelector:function(){var b=a("#route_type").find(":selected").val();a("#route_type_"+b).show();a.viewmodel.routeTypeSelected=b},validateLink:function(){var b=a("#pan_link_a"),c=a("#pan_link").val();if(this.regex.url.test(c)){b.attr("class","active").prop("href",c)}else{b.removeAttr("href").attr("class","")}},save:function(){var d=this,j=a("#editorContainer form"),f=j.serializeArray(),g=0,e=f.length,k=a.viewmodel.stopSelected,c=document.url_root+"stop/"+k.id,h={id:k.id},b;for(g;g<e;g+=1){b=f[g].name;switch(b){case b==="lon":h.geom["lon"]=f[g].value;break;case b==="lat":h.geom["lat"]=f[g].value;break;default:h[f[g].name]=f[g].value;break}}h.routes=this.getRoutesToSave(k);h.stop_types=this.getStopTypes(k);a.ajax({type:"POST",url:c,data:{stop:JSON.stringify(h)}}).done(function(){d.finishAjaxEdition()})},getRoutesToSave:function(e){var c=e.routes.routes,b=c.length,f=e.id,d=0,g=[];for(d;d<b;d+=1){g.push({stop_id:f,route_id:c[d].id})}return g},getStopTypes:function(c){var d=c.id;if(a("#stype_0").is(":checked")){return[{stop_id:d,stop_type_id:0}]}else{var b=[];a("#types .parameter.sub input:checked").each(function(){b.push({stop_id:d,stop_type_id:a(this).data("id")})});return b}},startAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/block/"+a.viewmodel.stopSelected.id}).done(function(){b.startEdit()})},startEdit:function(){var e=a.sm.helpers.getIcon("stop-editable",25),d=a.viewmodel,c=a.view,b;c.$body.addClass("editable");c.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");c.$editorContainer.find("form").removeClass("disabled");d.editable=true;b=L.marker([d.stopSelected.geom.lat,d.stopSelected.geom.lon],{icon:e,draggable:true});b.on("dragend",function(g){var f=g.target.getLatLng();a("#lat").val(f.lat);a("#lon").val(f.lng)});d.mapLayers.edit.addLayer(b);this.fillEditor(d.stopSelected);this.bindEventsForTypes();a("#chb_is_help").off("change").on("change",function(){if(this.checked){a("#is_help").val(1)}else{a("#is_help").val(0)}});d.map.closePopup()},bindEventsForTypes:function(){var b=a.view;a("#stype_0").off("change").on("change",function(){if(this.checked){a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}else{a("#types .parameters input").not("#stype_0").prop("disabled",false);a("#other_stype").prop("checked",true);a("#types .parameter.sub label").removeClass("disabled")}});a("#other_stype").off("change").on("change",function(){if(this.checked){a("#types .parameters input").prop("disabled",false);a("#stype_0").prop("checked",false);a("#types .parameter.sub label").removeClass("disabled")}else{a("#stype_0").prop("checked",true);a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}})},fillEditor:function(d){var e=a.sm.helpers;a("#name").val(d.name);a("#id").val(d.id).attr("disabled","disabled");a("#lat").val(d.geom.lat);a("#lon").val(d.geom.lon);this.fillRoutes(d.routes);for(var c=0,b=d.types.length;c<b;c+=1){a("#stype_"+d.types[c].id).prop("checked",true)}if(d.types.length>0&&d.types[0].id===0){a("#types .parameters input").not("#stype_0").prop("checked",false).not("#other_stype").prop("disabled",true);a("#types .parameter.sub label").addClass("disabled")}else{if(d.types.length>0&&d.types[0].id!==0){a("#types .parameters input").not("#stype_0").prop("disabled",false);a("#other_stype").prop("checked",true);a("#types .parameter.sub label").removeClass("disabled")}else{a("#types .parameter.sub label").addClass("disabled");a("#types .parameter.sub input").prop("disabled",true)}}a("#is_shelter").val(e.boolToString(d.is_shelter,true));a("#is_bench").val(e.boolToString(d.is_bench,true));a("#pan_link").val(e.valueNullToString(d.panorama_link));this.validateLink();a("#auto_link").prop("href",this.getPanoramaAutoLink(d.geom));a("#comment").val(e.valueNullToString(d.comment));a("#is_check").val(d.check_status_type_id);if(d.is_help){a("#is_help").val(1);a("#chb_is_help").prop("checked",true)}else{a("#is_help").val(0);a("#chb_is_help").prop("checked",false)}},getPanoramaAutoLink:function(b){var c=b.lon+","+b.lat;return"http://maps.yandex.ru/?ll="+c+"&spn=0.011795,0.004087&l=map,stv&ol=stv&oll="+c+"&ost=dir:0,0~spn:90,73.739795"},fillRoutes:function(b){var e=a.sm.helpers,f=b.sort(e.sortByFields("route_type_id","name")),d=0,c=f.length,g={ids:{},routes:f};for(d;d<c;d+=1){g.ids[f[d].id]=true;a("#routes").addTag(f[d].name,{css_class:"tag type-id-"+f[d].route_type_id})}a.viewmodel.stopSelected.routes=g},addRoute:function(f,c){var d=a.viewmodel,e=d.routeTypeSelected,b=d.stopSelected.routes;if(b.ids[f]){return false}else{b.ids[f]=true}b.routes.push({route_type_id:e,id:f,name:c});this.updateUIRoutes(b.routes)},removeRoute:function(e){var g=a.viewmodel,c=g.stopSelected.routes,b,f=0,d=c.routes.length;for(f;f<d;f+=1){if(c.routes[f].name===e){b=c.routes[f];c.ids[b.id]=false;c.routes.splice(f,1);break}}this.updateUIRoutes(c.routes)},updateUIRoutes:function(b){var d=0,c=b.length;b=b.sort(a.sm.helpers.sortByFields("route_type_id","name"));this.clearUIRoutes();for(d;d<c;d+=1){a("#routes").addTag(b[d].name,{css_class:"tag type-id-"+b[d].route_type_id})}},clearUIRoutes:function(){a("#routes").importTags("")},finishAjaxEdition:function(){var b=this;a.ajax({type:"GET",url:document.url_root+"stop/unblock/"+a.viewmodel.stopSelected.id}).done(function(){b.finishEditing()})},finishEditing:function(){var c=a.view.$document,d=a.viewmodel,b=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;b.$body.addClass("editable");b.$editorContainer.find("input, textarea").val("");b.$editorContainer.find("input:checkbox").prop("checked",false);b.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled");b.$editorContainer.find("form").addClass("disabled");a("#auto_link").prop("href","");a("#routes").importTags("");a.view.$document.trigger("/sm/map/updateAllLayers")}})})(jQuery);(function(a){a.extend(a.viewmodel,{osmStops:{}});a.extend(a.view,{});a.sm.osm={};a.extend(a.sm.osm,{osmMaxClusterRadius:80,init:function(){this.setDomOptions();this.buildOsmStopsLayer();this.updateStopsFromXapi();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/osm/updateOsmLayer",function(){b.updateOsmLayer()})},setDomOptions:function(){},buildOsmStopsLayer:function(){var b=new L.layerGroup();a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.osmStops=b},updateOsmLayer:function(){var b=this.validateZoom();a.viewmodel.mapLayers.osmStops.clearLayers();if(!b){return}this.updateStopsFromXapi()},offOsmLayer:function(){a.viewmodel.mapLayers.osmStops.clearLayers()},onOsmLayer:function(){this.updateOsmLayer(false)},renderStops:function(e){var j=e.elements,h=a.viewmodel,b=h.mapLayers.osmStops,g=a.sm.map.getIcon("osm-bus-stop",16),d;h.osmStops={};popupHtml=a.templates.stopPopupTemplate({css:"block"});for(var f=0,c=j.length;f<c;f++){h.osmStops[j[f].id]=j[f];d=L.marker([j[f].lat,j[f].lon],{icon:g}).on("click",function(n){a.view.$document.trigger("/sm/map/MarkerClick");var k=n.target,m=a.viewmodel.osmStops[k.id_osm],l=a.templates.osmPopupTemplate({tags:a.sm.helpers.hashToArrayKeyValues(m.tags),id:m.id,link:"http://www.openstreetmap.org/browse/node/"+m.id});a.view.$document.trigger("/sm/map/openPopup",[k.getLatLng(),l])});d.id_osm=j[f].id;b.addLayer(d)}},updateStopsFromXapi:function(){var c=this,b=c.getApiUrl(a.viewmodel.map.getBounds());a.ajax({type:"GET",url:b,dataType:"json",success:c.renderStops,context:c})},getApiUrl:function(d){var b=d.getSouthWest(),e=d.getNorthEast(),c="http://overpass-api.de/api/interpreter?data=[out:json];(node[highway=bus_stop]("+b.lat+","+b.lng+","+e.lat+","+e.lng+");>;);out;";return c},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{stopSelected:null,stopSelectedId:null,stops:null});a.extend(a.view,{});a.sm.stops={};a.extend(a.sm.stops,{init:function(){this.setDomOptions();this.buildStopsLayers();this.updateStops();this.bindEvents()},bindEvents:function(){var b=this;a.view.$document.on("/sm/stops/updateStops",function(){b.updateStops()})},setDomOptions:function(){},buildStopsLayers:function(){var c=new L.layerGroup(),b=new L.layerGroup();a.viewmodel.map.addLayer(c);a.viewmodel.mapLayers.stops=c;a.viewmodel.map.addLayer(b);a.viewmodel.mapLayers.edit=b},updateStops:function(){var b=this.validateZoom();a.viewmodel.mapLayers.stops.clearLayers();if(!b){return}a.view.$document.trigger("/sm/stops/startUpdate");this.updateStopsByAjax()},updateStopsByAjax:function(){var c=this,b=document.url_root+"stops",d=a.viewmodel.filter;a.ajax({type:"GET",url:b,data:{bbox:JSON.stringify(a.viewmodel.get_bbox()),filter:JSON.stringify(d)},dataType:"json",success:function(e){c.renderStops(e);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:c})},renderStops:function(j){var e=a.sm.map,f=a.viewmodel,p=f.mapLayers.stops,q=e.getIcon("stop-block",20),k=e.getIcon("stop-edit",20),m=e.getIcon("stop-check",20),c,n,l,o,h,d,g=a.templates.stopPopupTemplate({css:"edit"}),b=this;f.stops=j.stops;c=j.stops.block.elements;n=j.stops.block.count;for(l=0;l<n;l+=1){o=c[l];h=L.marker([o.lat,o.lon],{icon:q}).on("click",function(s){var r=s.target;a.view.$document.trigger("/sm/map/openPopup",[r.getLatLng(),g]);b.buildStopPopup(r.stop_id)});h.stop_id=o.id;p.addLayer(h)}c=j.stops.non_block.non_check.elements;n=j.stops.non_block.non_check.count;for(l=0;l<n;l+=1){o=c[l];h=L.marker([o.lat,o.lon],{icon:k}).on("click",function(s){var r=s.target;a.view.$document.trigger("/sm/map/openPopup",[r.getLatLng(),g]);b.buildStopPopup(r.stop_id)});h.stop_id=o.id;p.addLayer(h)}c=j.stops.non_block.check.elements;n=j.stops.non_block.check.count;for(l=0;l<n;l+=1){o=c[l];h=L.marker([o.lat,o.lon],{icon:m}).on("click",function(s){var r=s.target;a.view.$document.trigger("/sm/map/openPopup",[r.getLatLng(),g]);b.buildStopPopup(r.stop_id)});h.stop_id=o.id;p.addLayer(h)}},buildStopPopup:function(b){return a.getJSON(document.url_root+"stop/"+b,function(e){if(!a.viewmodel.editable){a.viewmodel.stopSelected=e.stop}var d=a.sm.helpers,c=a.templates.stopPopupInfoTemplate({id:e.stop.id,name:e.stop.name,is_shelter:d.boolToString(e.stop.is_shelter),is_bench:d.boolToString(e.stop.is_bench),stop_type_id:d.valueNullToString(e.stop.stop_type_id),routes:e.stop.routes,types:e.stop.types,check_status:d.valueCheckToString(e.stop.check_status_type_id),comment:d.valueNullToString(e.stop.comment),isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable||e.stop.is_block,isBlock:e.stop.is_block,userBlock:e.stop.user_block,isUnBlock:e.stop.is_unblock});a("#stop-popup").removeClass("loader").empty().append(c);a("button#edit").off("click").on("click",function(f){a.view.$document.trigger("/sm/editor/startEdit")});if(e.stop.is_unblock){a("#unblock").off("click").on("click",function(f){a.ajax({type:"GET",url:document.url_root+"stop/unblock/"+a.viewmodel.stopSelected.id}).done(function(){a.viewmodel.map.closePopup();a.view.$document.trigger("/sm/map/updateAllLayers")})})}}).error(function(){a("#stop-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<15){return false}return true}})})(jQuery);(function(a){a.extend(a.viewmodel,{isAuth:false});a.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.sm.user={};a.extend(a.sm.user,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$userContainer=a("#userContainer");a.view.$signInForm=a("#signInForm");a.view.$signOutForm=a("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},bindEvents:function(){var b=this;a("#signOutForm div.log").off("click").on("click",function(){b.renderLogs()})},renderLogs:function(){var b=document.url_root+"logs";a.view.$document.trigger("/sm/common/setMainLoad");a.ajax({type:"GET",url:b,dataType:"json",success:function(d){var c=a.templates.userLogsTemplate({user_logs:d.stops_by_users,count_all:d.count.all,count_editable:d.count.editable,percent:(d.count.editable/d.count.all*100).toFixed(2)});a.view.$body.removeClass("loader");a.view.$document.trigger("/sm/common/openPopup",["Статистика пользователей",c])}})}})})(jQuery);